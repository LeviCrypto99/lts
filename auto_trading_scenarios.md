# 자동매매 전체 워크플로우 시나리오 (명세서 1:1 반영)

- 기준일: 2026-02-01
- 기준 문서: `명세서 정리본.md`
- 목적: 실제 운영 중 발생 가능한 **모든 이벤트/상태 전이**를 시나리오 형태로 상세 정리
- 범위: 자동매매 엔진(신호 처리 → 필터링 → 모니터링 → 주문 → 체결 → 청산)

---

## 0. 범위/전제(명세 고정값)
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

- 거래 대상: Binance **USDT-M Perpetual** 만 (USDC-M/COIN-M 제외)
- 방향: 숏 전용
- 신호 채널
  - 진입 신호: `-1002171239233` (💥 ... 숏 진입 신호 발생!)
  - 주도마켓 분석: 진입신호 직후 동일 채널에 🔥 실시간 주도 마켓 분석(...)
  - 리스크관리: `-1003096527269` (🥈 ... 숏 리스크관리 권장)
- 판단 트리거
  - **진입신호는 판단 근거로 사용하지 않음**
  - **주도마켓 분석 메시지 수신이 필터링/모니터링 시작 트리거**
- 캔들 기준: 3분봉
- 가격 기준: **Mark Price** (WebSocket 우선, REST 폴백)
- PNL 기준: Binance 웹 표시 **ROI(수수료 미포함)** 사용
  - 숏 ROI(%) = (평단 - MarkPrice) / 평단 * 100
  - **PNL = 0은 ROI가 정확히 0%일 때만** 인정 (허용오차 없음)
- 주문 방식: 진입/추매/익절/본절은 **기본적으로 지정가** 기반
  - 예외 1) **Phase1에서 리스크관리 + PNL>0** → 본절을 STOP_MARKET으로 제출
  - 예외 2) 리스크관리 + PNL≤0 → 시장가 청산
  - 예외 3) 지정가 청산 거절 시 → 시장가 폴백
  - 예외 4) 청산 주문 부분체결 5초 정체 → 잔량 시장가 청산

---

## 1. 전역 불변 규칙(운영 중 항상 유지)
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

1) **전역 차단 규칙**
   - 활성 포지션이 하나라도 있거나, 미체결 진입 주문이 하나라도 있으면
     모든 신규 주도마켓 메시지를 **심볼 무관하게 무시**한다.
   - **미체결 진입 주문은 계정 전체(봇/수동 포함) 기준**으로 판단한다.
   - 역할: **신규 주도마켓 메시지 수신(입구) 자체를 차단**하는 규칙
   - 정책: **미체결 진입 주문 TTL 없음**, 전역 차단은 해제하지 않는다
   - 전제: 리스크관리 신호는 주도마켓(진입신호) 발생 이후 **필연적으로 수신** 된다.
2) **텔레그램 중복/과거 메시지 방지**
   - 채널별로 마지막 처리 `message_id`를 저장한다.
   - `message_id`가 **마지막 처리 id 이하이면 무시**한다. (재접속/중복 수신 방지)
3) **가격 소스 장애 전역 잠금**
   - `STALE_MARK_PRICE_SECONDS` 동안 **WS 미수신 + REST 최신 markPrice 스테일**이면 전역 잠금 진입
   - 전역 잠금 중: 신규 신호/모니터링/주문 전부 금지
   - 포지션 보유 중이면 **시장가 전량 청산**
   - 포지션 없음 + 모니터링/미체결 진입 주문 상태면 **모니터링 해제 + 미체결 주문 취소 + 초기화**
   - 최신 markPrice 정상 수신 시 전역 잠금 해제 (상태는 초기화 유지)

2) **심볼 상태 우선순위**
   - 보유 포지션 > 미체결 주문 > 모니터링 > 초기

3) **쿨다운 규칙**
   - 동일 심볼의 주도마켓 메시지는 COOLDOWN_MINUTES 내 재수신 시 **무조건 무시**
- 쿨다운 타임스탬프는 **수신 시점 기준**
- **쿨다운은 TICKER 파싱에 성공해 `{TICKER}USDT` 후보가 만들어진 경우에만 적용**
- 심볼이 특정된 이후에는 **필드 파싱 실패(펀딩비/순위/카테고리)** 여도 쿨다운 기록
- **exchangeInfo 검증 실패(미존재/거래중지)라도** TICKER 파싱 성공으로 후보 심볼이 생성됐다면 **쿨다운 기록**
- TICKER 파싱 실패로 심볼이 특정되지 않으면 쿨다운 기록 불가

4) **모니터링/미체결 주문/포지션 보유 중 설정 잠금**
   - MDD, TP-Ratio, 필터 모드 등은 수정 불가

---

## 2. 상태 머신(요약)
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

### 2.1 전역 상태(Global)
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

- `GLOBAL_IDLE`: 포지션 없음 + 미체결 진입 주문 없음
- `GLOBAL_LOCKED`: 포지션 존재 또는 미체결 진입 주문 존재

### 2.2 심볼 상태(Symbol)
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

- `IDLE`: 초기 상태
- `MONITORING`: 타점 모니터링(0.1% 알고리즘 대기)
- `ENTRY_ORDER`: 진입 주문 제출됨(NEW/OPEN/PARTIALLY_FILLED 포함)
- `PHASE1`: 1차 진입 전량 체결 완료
- `PHASE2`: 2차 진입 체결 발생(부분체결 포함) 이후의 **본절 우선 모드**
- `EXITING`: 청산 주문 진행 중(상호취소/OCO 규칙 적용 대상)

### 2.3 심볼 매핑 규칙 요약(주도마켓 기준)
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

- 주도마켓 제목: `🔥 실시간 주도 마켓 분석 (TICKER)`에서 TICKER 추출
- 허용 문자: 영문 대문자 A–Z + 숫자 0–9만 허용
- 정규화: trim → 제어문자/제로폭 제거 → 대문자 변환
- 주문 심볼: `{TICKER}USDT`
- 검증: Binance USDT-M Futures exchangeInfo에 존재 + 상태 TRADING
- 실패 처리: 파싱/정규화/검증 실패 시 “진입 불가”
  - 해당 심볼이 모니터링/미체결 주문/보유 포지션이면 무시(상태 유지)
  - 그 외는 초기 상태 유지

---

## 3. 이벤트별 상세 시나리오
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

### 3.0 진입신호(💥) 수신
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

#### W00. 진입신호 단독 수신
- 전제: 어떤 심볼 상태든 가능
- 입력: 💥 Binance : OOOUSDT.P ... 숏 진입 신호
- 판단: **진입신호는 자동매매 판단 근거로 사용하지 않음**
- 결과: 상태 변화 없음, 주도마켓 메시지 수신 대기

#### W00-1. 진입신호 연속 수신/순서 뒤섞임
- 입력: A/B 진입신호가 연속으로 수신되고 주도마켓 메시지가 지연 또는 순서 뒤섞임
- 결과: 진입신호는 무시, 주도마켓 메시지가 도착하는 시점부터만 판단

#### W00-2. 과거/중복 메시지 수신
- 입력: 재접속 등으로 과거 메시지 또는 동일 메시지 재수신
- 판단: `message_id`가 마지막 처리 id 이하인지 확인
- 결과: **즉시 무시** (상태 변화 없음)

### 3.1 주도마켓 메시지 수신(핵심 트리거)
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

#### W01. 전역 차단 상태에서 주도마켓 수신
- 전제: GLOBAL_LOCKED
- 입력: 🔥 실시간 주도 마켓 분석 메시지
- 판단: 전역 차단 규칙 적용
- 결과: **무조건 무시**, 어떤 심볼도 상태 변화 없음

#### W02. 쿨다운 내 동일 심볼 수신
- 전제: GLOBAL_IDLE
- 입력: 동일 심볼 주도마켓 메시지 재수신
- 판단: 쿨다운 타임스탬프 범위 내
- 결과: **무조건 무시** (모니터링/주문/포지션 여부와 무관)

#### W03. TICKER 파싱 실패
- 전제: GLOBAL_IDLE
- 입력: 제목 라인에서 TICKER 추출 실패(공백/특수문자/개행 포함)
- 판단: 심볼 매핑 불가
- 결과: 이벤트 무시(상태 변화 없음), 로그에 파싱 실패 기록

#### W03-1. TICKER 파싱 실패 시 쿨다운 기록 여부
- 조건: 심볼이 특정되지 않음
- 결과: **쿨다운 기록하지 않음**

#### W04. 심볼 정규화/검증 실패
- 전제: GLOBAL_IDLE
- 입력: TICKER 파싱 성공 → {TICKER}USDT 생성
- 판단: exchangeInfo 미존재 또는 TRADING 아님
- 결과:
  - 해당 심볼이 **모니터링/미체결 주문/포지션**이면 무시(상태 유지)
  - 그 외는 초기 상태 유지(사실상 리셋)

#### W05. 심볼은 정상이나, 필드 파싱 실패
- 전제: GLOBAL_IDLE, 심볼 검증 성공
- 입력: 펀딩비/등락/순위/카테고리 중 하나라도 파싱 실패 또는 "정보없음"
- 결과:
  - 심볼이 모니터링/주문/포지션이면 무시
  - 그 외는 초기 상태 유지

#### W05-1. 필드 파싱 실패 시 쿨다운 적용
- 조건: 심볼 파싱/검증은 성공했으나 이후 필드 파싱 실패
- 결과: **쿨다운 타임스탬프는 수신 시점 기준으로 기록**

#### W06. 동일 심볼이 이미 모니터링 중
- 전제: 해당 심볼 상태=MONITORING
- 입력: 동일 심볼 주도마켓 메시지
- 결과: 무시(상태 변화 없음)

#### W07. 동일 심볼이 미체결 주문/포지션 상태
- 전제: 해당 심볼 상태=ENTRY_ORDER/PHASE1/PHASE2
- 입력: 동일 심볼 주도마켓 메시지
- 결과: 무시(상태 변화 없음)

#### W08. 정상 파싱 + 검증 성공
- 전제: GLOBAL_IDLE + 쿨다운 미적용
- 입력: 정상 주도마켓 메시지
- 결과: 공통 필터링 단계로 이동

---

### 3.2 공통 필터링 조건
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

#### W09. 카테고리 제외 키워드 포함
- 조건: Meme/Defi/Pump.fun/DEX/탈중앙화 거래소/Binance Alpha Spotlight
- 결과: 공통 필터링 실패 → 심볼 상태 초기화

#### W10. 카테고리 = "정보없음"
- 결과: 공통 필터링 실패 → 심볼 상태 초기화

#### W11. 24H 등락 (상승) 상위 1~10위
- 결과: 공통 필터링 실패 → 심볼 상태 초기화

#### W12. 24H 등락 (하락) 상위
- 결과: 순위와 무관하게 통과

#### W13. 펀딩비 <= -0.1%
- 결과: 공통 필터링 실패 → 심볼 상태 초기화

#### W14. 모든 공통 필터 통과
- 결과: 모드 선택 단계 진입

---

### 3.3 모드 선택/타점 계산
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

#### W15. 공격적 모드 선택
- 타점: **신호 수신 시점의 직전 확정 3분봉 고점**
- 상태: MONITORING 진입
- 비고: 신규 3분봉 마감되어도 타점 갱신하지 않음

#### W16. 보수적 모드 선택
- 타점: **신호 수신 시점의 직전 확정 3분봉 ATR Upper Band**
- 상태: MONITORING 진입
- 비고: 신규 3분봉 마감되어도 타점 갱신하지 않음
  - ATR Upper Band 파라미터는 **indicator.py 구현을 단일 소스**로 사용

---

### 3.4 타점 모니터링(0.1% 알고리즘)
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

#### W17. 모니터링 시작
- 조건: GLOBAL_IDLE + 공통 필터 통과 + 모드 결정
- 결과: 0.1% 알고리즘 가동, 모니터링 리스트 등록

#### W17-1. 모니터링 단계의 제한
- 동작: **주문 취소/레버리지 변경/마진 모드 변경을 수행하지 않음**
- 시점: 0.1% 트리거 충족 직후(주문 직전)에만 수행

#### W17-2. 0.1% 트리거 계산(숏 기준)
- 1차 진입: T1 = P1 * (1 - 0.001). **현재가가 T1 이상**이면 P1에 지정가 주문 제출
- 2차 진입: P2 = Pavg * (1 + 추매퍼센트), T2 = P2 * (1 - 0.001). **현재가가 T2 이상**이면 P2 지정가 제출
- TP: Ptp = Pavg * (1 - TP%), Ttp = Ptp * (1 + 0.001). **현재가가 Ttp 이하**이면 Ptp 지정가 청산
- 본절: Pbe = Pavg, Tbe = Pbe * (1 + 0.001). **현재가가 Tbe 이상**이면 Pbe 지정가 청산
- 트리거 최초 평가 시 이미 만족하면 즉시 주문 제출(재접근 대기 없음)

#### W18. 동일 1초 평가 루프에서 다수 심볼 트리거
- 조건: 2개 이상 심볼이 동일 1초 평가 루프에서 트리거 충족
- 결과: **주도마켓 메시지 수신 시각이 더 늦은 종목**만 주문 제출, 나머지 심볼 즉시 초기화
 - 수신 시각이 같으면 **message_id가 더 큰** 종목을 선택
 - 역할: **이미 모니터링 중인 종목 간 동시 진입 충돌을 해결**하는 규칙

#### W19. 트리거 최초 평가 시 이미 만족
- 조건: 모니터링 시작 직후 현재가가 트리거 조건 이미 충족
- 결과: 대기 없이 즉시 주문 제출

#### W20. 가격이 1초 사이에 스치고 지나감
- 조건: 평가 간격 사이에 트리거 구간 통과했으나 평가 시점에는 미충족
- 결과: **감지하지 않음**, 대기 계속

#### W21. WebSocket 정상 수신
- 결과: markPrice@1s를 사용하여 트리거 평가 및 PNL 계산

#### W22. WebSocket 5초 이상 미수신
- 결과: REST /fapi/v1/premiumIndex로 폴백, 1초 주기 평가 유지

#### W23. WebSocket 재수신
- 결과: WebSocket 기반 평가로 즉시 복귀, 전환 시각 로그

#### W23-1. Mark Price 스테일(WS/REST 동시 장애)
- 조건: `STALE_MARK_PRICE_SECONDS` 이상 WS 미수신 + REST 최신 markPrice도 스테일
- 결과:
  - **전역 잠금** 진입 (신규 신호/모니터링/주문 금지)
  - 포지션 보유 시 **시장가 전량 청산**
  - 포지션 없음 + 모니터링/미체결 주문 상태면 **모니터링 해제 + 미체결 주문 취소 + 초기화**
  - markPrice 정상 수신 시 전역 잠금 해제

---

### 3.5 주문 직전 설정(레버리지/마진/포지션 모드)
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

#### W24. 레버리지/격리모드 변경 필요
- 조건: 0.1% 트리거 충족 직후, 레버리지!=1 또는 격리모드 아님
- 흐름:
  1) 레버리지=1, 격리모드 변경 시도
  2) 실패 원인이 **해당 심볼 미체결 주문**이면 그 주문만 취소
  3) 재시도
- 결과:
  - 성공 시 주문 제출 진행
  - 재시도 실패 또는 원인 불명확 시 로그 후 초기화(주문 금지)

#### W25. 레버리지/격리모드 이미 설정됨
- 결과: 변경 단계 스킵 → 주문 제출로 이동

#### W26. 포지션 모드 조회 실패
- 결과: 해당 심볼 주문 금지 + 상태 초기화

#### W27. HEDGE 모드
- 결과: 모든 주문에 positionSide=SHORT 명시

#### W28. ONE-WAY 모드
- 결과: positionSide 전송하지 않음, reduceOnly 규칙 사용

---

### 3.6 주문 가격/수량 정규화
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

#### W29. 가격 정규화(PRICE_FILTER)
- 계산된 목표가 P → tickSize 기준 반올림
- **LIMIT 가격과 STOP/STOP_MARKET의 stopPrice 모두 동일 반올림** 적용
- P_adj <= 0이면 주문 금지 + 상태 초기화

#### W30. 수량 정규화(LOT_SIZE)
- 계산된 수량 Q → stepSize 기준 내림
- Q_adj < minQty면 주문 금지 + 로그 + 상태 초기화

#### W31. MIN_NOTIONAL 미달
- 결과: 주문 금지 + 상태 초기화

#### W32. 0.1% 트리거 기준
- 결과: **정규화된 목표가(P_adj)** 기준으로 트리거 계산

### 3.6-1 진입 비중/수량 산출
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

#### W32-1. 1차 진입 자금 계산
- 기준: USDT-M 선물 지갑 USDT 잔고
- 계산: 1차 진입 자금 = 잔고 * 50%
- 레버리지: 1배 고정(격리모드)

#### W32-2. 1차 진입 수량 계산
- 계산: 수량 = (1차 진입 자금) / (정규화된 목표가)
- 이후: LOT_SIZE 규칙으로 내림 정규화

#### W32-3. 2차 진입 자금 계산
- 조건: 1차 진입 전량 체결 완료 후에만 수행
- 기준: 선물 지갑 **가용(available) USDT** 기준
- 계산: 2차 진입 자금 = available USDT * (1 - MARGIN_BUFFER_PCT)
  - MARGIN_BUFFER_PCT는 수수료/미체결 예약/PNL 변동 여유 버퍼 (예: 0.5~2%)
  - 버퍼는 config로 조정 가능

#### W32-4. 2차 진입 수량 계산
- 계산: 수량 = (2차 진입 자금) / (정규화된 2차 목표가)
- 이후: LOT_SIZE 규칙으로 내림 정규화

#### W32-5. 자금 부족/정규화 후 주문 불가
- 조건: minQty/minNotional 미달 또는 정규화 결과 수량 0
- 결과: 주문 금지 + 사유 로그 + 해당 심볼 상태 초기화

#### W32-6. 2차 진입 사전 마진 체크
- 조건: 2차 진입 직전, available USDT가 0 또는 버퍼 적용 후 0 이하
- 결과: 2차 진입 스킵 + 로그 기록(자금 부족)

---

### 3.7 진입 주문 제출/재시도
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

#### W33. 지정가 진입 주문 제출
- 결과: 항상 지정가 주문, 시장가 금지
  - `timeInForce=GTC` 고정 (TTL 없음)
  - **reduceOnly 사용 금지(또는 false)** 로 제출
  - 재시도 시 **동일 `newClientOrderId`** 로 중복 주문 방지

#### W34. 목표가와 현재가 괴리
- 예: 목표가 1.0, 현재가 1.1
- 결과: 여전히 1.0에 지정가 주문 제출

#### W35. 주문 제출 실패(일시적)
- 결과: 동일 주문 최대 3회 재시도 → 실패 시 로그 후 상태 초기화

#### W35-1. 주문 실패 사유가 INSUFFICIENT_MARGIN
- 조건: 거래소 응답이 증거금 부족(INSUFFICIENT_MARGIN 등)
- 동작:
  - **1차 진입**: 재시도 없이 즉시 로그 기록 후 해당 심볼 상태 초기화
  - **2차 진입**:
    1) available USDT 재조회
    2) MARGIN_BUFFER_PCT 재적용 후 수량 재계산
    3) LOT_SIZE 정규화 후 재시도
- 결과:
  - 재시도 성공 시 진행
  - 재시도 실패 시 2차 진입 스킵 + 로그 기록

---

### 3.8 주문 체결 상태 전이
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

#### W36. 미체결 유지
- 상태: ENTRY_ORDER, q1=0
- 결과: 주문 유지(만료 없음). 리스크관리 수신 시에만 취소

#### W36-1. 리스크관리 미수신 시 미체결 주문 유지
- 조건: ENTRY_ORDER 상태에서 리스크관리 신호 없음
- 결과: 미체결/잔여 진입 주문 **TTL 없이 유지** (자동 취소/재주문 없음)

#### W36-2. 미체결 주문/포지션 존재 시 다른 심볼 차단
- 조건: 미체결 진입 주문 존재 또는 포지션 체결 발생
- 결과: 다른 심볼 신규 모니터링/주문/신호 처리 전부 중단
  - 미체결 진입 주문은 **계정 전체(봇/수동 포함) 기준**

#### W37. **1차 진입 주문** 부분체결(PARTIALLY_FILLED)
- 상태: ENTRY_ORDER 유지
- 동작:
  - 잔여 1차 진입 주문 유지
  - TP 0.1% 알고리즘 활성화
  - 평균가 변경 시 TP 주문 취소 후 재등록

#### W38. 부분체결 상태에서 리스크관리 수신
- 결과:
  - 잔여 진입 주문 즉시 취소
  - PNL 규칙 적용(음수=시장가 청산, 0=시장가, 양수=본절+TP 유지)

#### W39. 완전 체결(FILLED)
- 결과: 상태 PHASE1 전환, 2차 진입 모니터링 준비

---

### 3.9 Phase 1 (1차 진입 전량 체결 이후)
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

#### W40. TP 0.1% 알고리즘 활성
- 조건: PHASE1 진입 직후
- 결과: TP 목표가에 0.1% 알고리즘 적용

#### W41. 2차 진입 모니터링 시작
- 조건: PHASE1 진입 직후
- 타점: 평단 + 15%(config 값)
- 결과: 2차 진입 0.1% 알고리즘 대기

#### W42. MDD 스탑로스 비활성
- 조건: PHASE1
- 결과: MDD 스탑로스 제출 금지
  - 정책: Phase1 손절은 **리스크관리 신호**에만 의존

---

### 3.10 Phase 2 (2차 진입 체결 발생 이후)
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

#### W43. 2차 진입 주문 **부분체결 이상** 발생
- 결과: **Phase2(본절 우선 모드)로 간주**하고 TP 목표가를 평단으로 변경
  - 본절 TP는 **0.1% 지정가 청산** 방식으로 운영
  - 2차 체결로 평단이 바뀌면 **본절 TP 주문은 취소 후 재등록**
  - **Phase2 전환 시 기존 TP 주문이 존재하면 즉시 취소**하고, **본절 0.1% 지정가만 유지**
  - **본절 청산 트리거 발생 시** 잔여 2차 진입 주문은 **즉시 취소**하고 본절 청산 진행

#### W43-1. 2차 진입 전량 체결
- 결과: MDD 스탑로스(STOP_MARKET) **최초 제출**
  - 평단이 변경될 수 있으므로, **전량 체결 시점에만** 제출

---

### 3.11 리스크관리/청산 상세 시나리오
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

- 범위: 리스크관리 신호 처리, 청산 주문 생성/우선순위/OCO/부분체결 처리

#### 3.11-1 핵심 규칙 요약
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

- 리스크관리 신호는 **해당 심볼 상태가 모니터링/미체결 주문/보유 포지션일 때만** 처리
- PNL 계산 기준: **Mark Price + ROI(수수료 미포함)**, ROI=0%만 PNL=0
- 리스크관리 신호 처리 우선순위(동일 루프 기준):
  1) 리스크관리 + PNL <= 0 → 시장가 청산
  2) 스탑류(MDD 스탑, 본절 스탑)
  3) TP/본절 지정가 청산
- Phase 1: TP 0.1% 활성, 2차 진입 모니터링 활성, MDD 스탑 금지
- Phase 2: 2차 체결 발생 시 TP를 **평단 본절 목표**로 전환(0.1% 지정가)
  - MDD 스탑은 **2차 전량 체결 시점에만** 제출

#### 3.11-2 리스크관리 신호 파싱/검증 시나리오
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

##### R00. 리스크관리 메시지 형식 정상
- 입력: 🥈 Binance : OOOUSDT.P 에서 숏 리스크관리 권장
- 처리:
  - "Binance :" 뒤 토큰 추출
  - .P 제거 → 심볼 정규화
  - 주도마켓 심볼 매핑 규칙과 동일한 검증 적용
- 결과: TRADING 심볼이면 리스크관리 로직 수행

##### R00-1. 리스크관리 메시지 파싱 실패
- 조건: 형식 불일치, 특수문자 포함, .P 제거 실패 등
- 결과: 해당 리스크관리 신호 **무시**

##### R00-2. 심볼 검증 실패
- 조건: exchangeInfo 미존재 또는 TRADING 아님
- 결과: 해당 리스크관리 신호 **무시**

#### 3.11-3 리스크관리 신호 처리 시나리오
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

##### R01. 모니터링 상태에서 리스크관리 수신
- 전제: 심볼 상태=MONITORING
- 동작: 모니터링 즉시 해제, 상태 초기화
- 주문/포지션 영향: 없음

##### R02. 미체결 진입 주문 상태에서 리스크관리 수신
- 전제: 상태=ENTRY_ORDER, 포지션 수량=0
- 동작: 해당 심볼 미체결 주문 전부 취소
- 결과: 상태 초기화

##### R03. 부분체결 상태에서 리스크관리 수신
- 전제: ENTRY_ORDER + PARTIALLY_FILLED
- 동작:
  - 잔여 진입 주문 즉시 취소
  - 현재 포지션 기준으로 PNL 계산 → 아래 분기 적용

##### R04. 포지션 보유 중 리스크관리 수신 + PNL < 0
- 동작: 시장가 전량 청산
- 비고: reduceOnly/positionSide 규칙 적용

##### R05. 포지션 보유 중 리스크관리 수신 + PNL = 0
- 동작: 시장가 즉시 청산

##### R06. 포지션 보유 중 리스크관리 수신 + PNL > 0 (Phase 1)
- 동작:
  - 본절 스탑로스(STOP_MARKET) 제출
  - TP는 **활성 상태일 경우에만 유지**

##### R07. 포지션 보유 중 리스크관리 수신 + PNL > 0 (Phase 2)
- 동작:
  - 기존 MDD 스탑로스를 취소하고 본절 목표로 변경하지 않음
  - **본절은 0.1% 지정가 청산** 방식 유지
  - STOP_MARKET 본절로 덮어쓰지 않음

##### R08. 다른 심볼 리스크관리 수신
- 전제: 현재 활성 심볼과 다름
- 결과: 무시(상태 변화 없음)

#### 3.11-4 청산 주문 파라미터/안전 규칙
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

##### R09. ONE-WAY 모드
- 지정가 TP/본절/기타 청산: reduceOnly=true
- STOP_MARKET/TAKE_PROFIT_MARKET: closePosition=true (quantity 미사용)

##### R10. HEDGE 모드
- 지정가 청산: positionSide=SHORT + quantity 제출
- STOP_MARKET/TAKE_PROFIT_MARKET: positionSide=SHORT + closePosition=true

##### R11. 청산 주문 안전 규칙
- 청산 수량은 보유 포지션 수량 초과 금지
- 초과 시 수량 강제 보정 또는 주문 차단

##### R11-1. 스탑 트리거 기준
- 모든 스탑 트리거는 **Mark Price 기준** (workingType=MARK_PRICE)

##### R12. 청산 지정가 거절
- 조건: 지정가 청산 주문이 오류로 거절됨
- 결과: 즉시 취소 후 시장가 청산으로 폴백

#### 3.11-5 Phase별 청산 로직
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

##### R13. Phase 1 (1차 전량 체결 직후)
- 활성:
  - TP 0.1% 알고리즘(모니터링만 수행)
  - 2차 진입 모니터링
  - 리스크관리 대기
- 금지:
  - MDD 스탑로스 제출
  - 별도 손절 페일세이프 없음(리스크관리 신호에만 의존)

##### R14. Phase 2 (2차 체결 발생 이후)
- 동작:
  - 2차 **부분체결 이상** 발생 시 TP 목표를 평단 본절로 전환
  - 본절은 0.1% 지정가 청산
  - MDD 스탑로스(STOP_MARKET)는 **2차 전량 체결 시점에만** 제출

#### 3.11-6 청산 OCO/상호취소 시나리오
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

##### R15. 청산 주문 중 하나 FILLED
- 동작: 같은 심볼 잔여 청산 주문 즉시 취소
- 실패 시 최대 3회 재시도
- 3회 실패 시: 상태를 “청산 취소 실패”로 표시, 신규 주문 금지

##### R16. 잔여 청산 주문 재조회
- 조건: 취소 실패 이후 주기적 Open Orders 조회
- 결과: 잔여 주문 존재 시 재취소 시도

#### 3.11-7 청산 우선순위/동시 발생
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

##### R17. 동일 평가 루프 내 동시 트리거
- 우선순위:
  1) 리스크관리 + PNL <= 0 → 시장가 청산
  2) 스탑류(MDD/본절 STOP_MARKET)
  3) TP/본절 지정가 청산

##### R18. 리스크관리 시장가 청산 vs 5초 룰
- 조건: 동일 루프 내에서 발생
- 결과: 리스크관리 청산 우선, 5초 룰 청산 생략

#### 3.11-8 청산 주문 부분체결 5초 룰
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

##### R19. 청산 주문 PARTIALLY_FILLED 후 5초 정체
- 동작: 잔량 주문 취소 → 잔여 수량 시장가 청산
- 적용 대상: **청산 주문에만 적용** (진입 주문 제외)

#### 3.11-9 포지션 동기화/외부 변화
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

##### R20. 포지션 수량 변경 감지(수동/강제 청산 포함)
- 동작: 해당 심볼 모든 청산 주문 취소
- 이후: 현재 포지션 수량 기준으로 필요한 청산 주문만 재등록

##### R21. 포지션 수량 0
- 동작: 모든 주문 취소 + 상태 초기화

##### R22. dust 발생(minQty 미만)
- 동작: dust는 포지션 없음으로 처리
- 결과: 해당 심볼 청산 주문 모두 취소, 재등록하지 않음
- 주의: dust는 “활성 포지션”으로 간주하지 않음

#### 3.11-10 리스크관리/청산 예시 시나리오
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

##### R23. Phase 1에서 리스크관리 + PNL > 0
- 본절 STOP_MARKET 제출 + TP 유지

##### R24. Phase 2에서 리스크관리 + PNL > 0
- 본절은 0.1% 지정가 유지
  - MDD가 제출된 상태면 **유지**
  - 2차 전량 체결 전이라면 MDD는 **없음**

##### R25. TP 주문 부분체결 → 5초 룰
- 잔량 취소 후 시장가로 잔여 청산

##### R26. 리스크관리 + PNL < 0 (동일 루프에 TP 트리거 존재)
- 시장가 청산 우선, TP 주문은 취소

---

### 3.12 모니터링 리스트/상태판 시나리오
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

#### W45. 모니터링 리스트 등록
- 표시 항목: 종목 / 필터 성향(공격/보수) / 상태(1차/2차) / 진입 예정가

#### W46. 특정 심볼이 주문 제출됨
- 결과: 다른 모니터링 심볼 전부 제거 + 초기화

#### W47. 1차 체결 → 2차 진입 전환
- 결과: 리스트 상태 1차 → 2차로 업데이트, 예정가 재계산

---

### 3.13 환경/통신 예외 시나리오
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

#### W48. exchangeInfo 조회 실패
- 결과: 진입 불가 처리 + 상태 초기화

#### W49. 서버 시간 드리프트(-1021 등)
- 결과: 주문 실패 → 재시도/로그/상태 유지 또는 초기화

#### W50. REST/WS 레이트리밋
- 결과: 재시도 + 백오프, 지속 실패 시 주문/청산 금지

#### W51. API 키 권한 부족
- 결과: 주문/조회 실패 → 로그 + 상태 초기화

---

### 3.14 로깅/감사 추적 시나리오
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

#### W51-1. 심볼 매핑 로그
- 기록 항목: 원본 TICKER, 정규화 TICKER, 후보 심볼, 검증 결과, 실패 사유 코드

#### W51-2. WebSocket ↔ REST 폴백 로그
- 기록 항목: 전환 시각, 전환 사유(연결 종료/타임아웃/예외 메시지)

#### W51-3. 주문 실패/취소 실패 로그
- 기록 항목: 주문 파라미터, 실패 코드/메시지, 재시도 횟수, 최종 결과

---

## 4. 종합 시나리오(대표 플로우)
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

### W55. 정상 진입 → TP 익절
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

- 주도마켓 수신 → 공통 필터 통과 → 모니터링 → 0.1% 트리거 → 주문 FILLED
- PHASE1 → TP 트리거 → 지정가 청산 FILLED → 잔여 청산 주문 취소 → 초기화

### W56. 정상 진입 → 2차 체결 → 본절 청산
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

- 1차 FILLED → 2차 모니터링 → 2차 FILLED → PHASE2 전환
- 본절 목표(평단) 0.1% 트리거 → 지정가 청산 → 초기화

### W57. 부분체결 중 리스크관리 → 손절
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

- PARTIALLY_FILLED 상태 → 리스크관리 수신 → 잔여 주문 취소 → 시장가 청산

---

## 5. 코드 매핑 (현재 코드 기준)
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

> **중요**: 현재 코드베이스에는 자동매매 엔진/텔레그램 수신/웹소켓/주문 상태머신이 구현되어 있지 않음.
> 아래 표는 “명세 요소 → 현재 코드 존재 여부/연관 함수”를 정리한 것이다.

| 명세 요소 | 현재 코드 위치 | 현황/갭 |
|---|---|---|
| 텔레그램 주도마켓/리스크관리 수신 | (없음) | **미구현**. 별도 모듈 필요 |
| 심볼 파싱/정규화/검증 | (없음) | **미구현**. exchangeInfo 캐시 로직 필요 |
| 쿨다운 관리 | (없음) | **미구현** |
| 공통 필터링(카테고리/등락/펀딩비) | (없음) | **미구현** |
| 모드 선택/타점 고정 | `indicators.py` | ATR 밴드 계산 함수 존재. 고점 추출/모니터링 연동은 **미구현** |
| 0.1% 알고리즘/Mark Price WS | (없음) | **미구현**. WebSocket/REST 폴백 필요 |
| 레버리지/격리모드 변경 | (없음) | **미구현** |
| 포지션 모드(ONE-WAY/HEDGE) 조회 | (없음) | **미구현** |
| 주문 가격/수량 정규화 | `indicators.py.adjust_price`, `trade_page.py._get_symbol_filters` | 부분 구현(가격/LOT_SIZE만). MIN_NOTIONAL, 주문 파이프라인 **미구현** |
| 주문 제출/재시도 | `trade_page.py._binance_signed_post` | REST POST 래퍼 존재. 자동매매 주문 로직 **미구현** |
| 포지션/미체결 주문 조회 | `trade_page.py._fetch_open_positions` | 조회 함수 존재. 자동매매 상태머신 연동 **미구현** |
| 리스크관리/청산 로직 | (없음) | **미구현** |
| 설정 잠금(모니터링/포지션 중) | `trade_page.py` UI 일부 | 자동매매 상태 연동 **미구현** |
| config 기반 채널/쿨다운/퍼센트 | `config.py` | 업데이트용 설정만 존재. 트레이딩 설정 **미구현** |

---

## 6. 누락 방지 체크리스트(명세 기반)
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

- 주도마켓 메시지 **전용 트리거** 여부 확인
- 쿨다운 적용 범위(수신 시점 기준, 검증 실패 포함) 확인
- 전역 차단 규칙(포지션/미체결 존재 시 신규 신호 무시) 확인
- 공통 필터링 3종(카테고리/등락/펀딩비) 케이스별 처리 확인
- 공격/보수 타점 고정 규칙 확인
- 0.1% 알고리즘 트리거 및 Mark Price 소스 통일 확인
- 레버리지/격리/포지션 모드 변경 순서 및 실패 분기 확인
- 주문 정규화 규칙(PRICE_FILTER/LOT_SIZE/MIN_NOTIONAL) 확인
- 부분체결/완전체결 상태 전이 및 TP 재등록 규칙 확인
- Phase 1/Phase 2 전환 및 스탑/본절/TP 우선순위 확인
- 리스크관리 신호 수신 시 PNL 분기 처리 확인
- 청산 OCO/부분체결 5초 룰/잔여 취소 실패 재시도 확인
- dust 처리 및 상태 머신 초기화 규칙 확인

---

## 7. 구현 시 유의사항 (예상 오류 체크리스트)
로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

※ 아래 항목은 **명세 규칙과 별개로 구현 단계에서 방어가 필요한 환경/통신/운영 리스크**를 정리한 참고 목록이다.

1) 신호 수신 환경
- 채널 ID/권한 변경, 봇 삭제·읽기 불가
- 메시지 지연/중복/순서 뒤섞임, 진입신호-주도마켓 불일치/누락
- 포맷 변형(이모지 누락/공백/줄바꿈) 발생 가능성

2) 시장 데이터/시간
- WebSocket 끊김/지연, markPrice 누락
- REST 폴백 실패·레이트리밋·백오프
- 서버 시간 드리프트(타임스탬프/서명 오류)

3) 거래소/HTTP
- API 키 권한 부족(선물/읽기), IP 제한
- 레이트리밋/타임아웃/네트워크 오류

4) 거래소 메타데이터
- exchangeInfo/filters 조회 실패/지연, 캐시 스테일

5) 상태 동기화(운영)
- 수동 청산/강제 청산/수동 주문 등 외부 변경 감지 주기
- 잔존 주문/포지션 변화 재조회 주기

6) 구현 체크
- 서버 시간 동기화 누락 시 서명 오류(-1021) 가능
- 거래소 필터(PRICE_FILTER/MIN_NOTIONAL 등) 적용 누락 가능

7) 주문/계정 모드 관련
- INSUFFICIENT_MARGIN, MIN_NOTIONAL, LOT_SIZE, PRICE_FILTER 등 거래소 주문 거절 코드
- ONE-WAY/HEDGE 모드 불일치 또는 positionSide 누락으로 인한 주문 거절
- 레버리지/격리모드 변경 실패 (open order/권한/제약)
- reduceOnly/closePosition 파라미터 오류

8) 주문/체결 이벤트 불일치
- 주문 상태 업데이트 지연/누락(REST와 WS 불일치)
- 부분체결/평단 갱신 이벤트 누락 → TP/본절 재등록 타이밍 누락 가능

9) 상태 복구/재시작
- 프로세스 재시작 시 메모리 상태 유실 → 현재 포지션/오픈오더 재동기화 필요
- 중복 주문/중복 상태 전이 위험

10) 강제 청산/ADL
- 강제 청산 또는 ADL로 포지션이 외부에서 종료됨 → 상태 동기화 필요
