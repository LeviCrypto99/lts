# == 구현 전 참고사항 ==
※ 로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

0.우리가 구현할 "자동매매" 프로그램은 바이낸스 **USDT-M Perpetual** 상장 알트코인 및 BTC 숏포지션을 타겟이다. (USDC-M/COIN-M 제외)
   - BTC는 포함 대상이지만 실제로는 대형 종목 알림이 거의 오지 않는다는 전제를 둔다.

1.텔레그램 채널 -1002171239233은 "진입신호" 를 수신할 채널이다. (별개의 로직으로 구현되어 있음.)

2.텔레그램 채널 -1002171239233의 워크플로우는 아래와 같다.

2-1.-1002171239233 채널에 💥 Binance : OOOUSDT.P 에서 숏 진입 신호 발생! 이라는 신호가 수신됨. (해당 진입신호 양식은 결코 바뀌지 않는다.)

2-2.🔥 실시간 주도 마켓 분석 (BTC)

📈 주도 마켓: 바이낸스 , 바이비트 , 비트겟 등 내부로직에 의해 출력됨.

⏱️Binance 펀딩비 및 카운트다운 : N.NNNN% / hh:mm:ss (4h)

🥇지난 24H 등락률 및 순위 : +NN.NN% / (상승 또는 하락) 상위 N위

🏷️카테고리 : (OOO코인의 카테고리)

🔗Liq HeatMap : 히트맵 링크 (https://www.coinglass.com/ko/pro/futures/LiquidationHeatMap?coin=OOO\&type=symbol)

2-1번의 코인정보에 대해 분석을 시행하고 위와같은 메시지를 추가로 전송함 (주도마켓는 결코 양식이 바뀌지 않는다.)

3.텔레그램 채널 -1003096527269은 "리스크관리" 신호 수신 채널이며 🥈 Binance : OOOUSDT.P 에서 숏 리스크관리 권장 의 양식을 따른다. 마찬가지로 양식은 변하지 않는다.

3-1.리스크관리 신호는 이후에 작성할 "청산/리스크 축소" 관련 로직 또는 "주문취소" 의 트리거 역할을 수행한다.

4.주도마켓 신호는 **진입신호가 3분봉 마감 시점에 수신될 때**, 해당 종목에 대해 즉시 전송된다.
   (즉, 주도마켓 신호는 별도 주기 방송이 아니라 진입신호 후속 분석 메시지이며 3분봉 마감 직후에만 발생한다.)

5.리스크관리 신호는 청산/리스크 축소 트리거이다.
  - PNL < 0: **시장가 전량 청산** (Phase 구분 없음, 최우선)
  - PNL = 0: 포지션 즉시 종료(시장가 청산)
  - PNL > 0:
    - Phase1: STOP_MARKET 본절 스탑 + TP 유지 (**TP 주문이 이미 있으면 유지, 없으면 즉시 TP 지정가 주문 1회 생성**)
    - Phase2: 본절 0.1% 지정가 유지(스탑으로 덮지 않음), MDD는 제출돼 있으면 유지



# === 주도마켓 티커(TICKER) → Binance USDT-M Perp 주문 심볼 매핑 규칙 ===
※ 로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

0) 대상 범위는 USDT-M Perpetual만으로 한정한다. (USDC-M/COIN-M 제외)
0-1) 검증은 USDT-M Futures(exchangeInfo) 기준으로 한다

1) 티커 추출 및 정규화 규칙

주도마켓 메시지의 제목 라인 🔥 실시간 주도 마켓 분석 (TICKER)에서 TICKER를 추출한다.

TICKER는 영문 대문자 A–Z 및 숫자 0–9만 허용한다.

선행/후행 공백은 trim으로 제거 후 처리한다. trim 이후 내부 공백/개행/특수문자(/ - _ . : 등)가 남아 있으면 파싱 실패로 간주한다.

파싱된 TICKER는 다음 정규화를 수행한다.

앞뒤 공백 제거(trim)

제로폭/제어문자 제거(sanitize)

대문자 변환(upper)

2) 바이낸스 주문 심볼 생성 규칙

기본 주문 심볼은 {TICKER}USDT로 구성한다.

3) 주문 가능 심볼 검증 규칙 (필수)

주문 전, 후보 심볼이 Binance USDT-M Perpetual 심볼 목록(exchangeInfo)에 존재하는지 확인한다.

존재하더라도 심볼 상태가 TRADING이 아니면 제외한다.

검증 실패 시:

- 검증 실패에는 **심볼 미존재/TRADING 아님** 뿐 아니라 **exchangeInfo 조회 실패(타임아웃/네트워크/레이트리밋/권한 오류 등)** 도 포함한다.
- 해당 이벤트는 “매핑 실패”로 기록한다.
- 해당 심볼이 **모니터링/미체결 주문/보유 포지션 상태**라면 **무시**하고 기존 상태를 유지한다.
- 그 외(아직 공통조건 통과 전 단계)라면 **진입 대상에서 제외 + 상태 완전 초기화**한다.

4) 실패/예외 처리 규칙

파싱 실패, 정규화 실패, 검증 실패(exchangeInfo 조회 실패 포함)는 모두 “진입 불가”로 처리한다.
단, 해당 심볼이 **모니터링/미체결 주문/보유 포지션 상태**라면 **무시**하고 기존 상태를 유지한다.

실패 시에도 시스템은 중단하지 않고, 다음 주도마켓 이벤트를 대기한다.

동일 티커의 주도마켓 이벤트가 쿨다운 시간 내 재수신되면 무시한다.

COOLDOWN_MINUTES는 config에서 조정 가능

쿨다운 적용 기준:
- **전역 차단(ENTRY_LOCK, 입구 차단) 상태에서 무시된 메시지는 쿨다운을 기록하지 않는다.**
- **TICKER 파싱에 성공해 `{TICKER}USDT` 후보 심볼이 생성된 경우에만** 쿨다운을 기록한다.
- 심볼이 특정된 이후에는 **필드 파싱 실패(펀딩비/순위/카테고리)** 여도 쿨다운을 기록한다.
- **exchangeInfo 검증 실패(미존재/거래중지)라도** TICKER 파싱 성공으로 후보 심볼이 생성됐다면 **쿨다운을 기록한다.**
- TICKER 파싱 실패로 심볼이 특정되지 않으면 쿨다운은 기록하지 않는다.

5) 로깅

심볼 처리 이벤트마다 다음을 기록한다:

원본 TICKER, 정규화된 TICKER

생성한 후보 심볼 리스트(예: SYNUSDT)

검증 결과(존재/미존재, TRADING 여부)

실패 사유 코드(파싱실패/검증실패/거래불가 등)


# === 리스크관리 신호 심볼 파싱/검증 규칙 ===
※ 로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

0) 리스크관리 신호의 심볼 처리도 **주도마켓 심볼 매핑 규칙과 동일한 방어 로직**을 적용한다.

1) 리스크관리 메시지의 형식: 🥈 Binance : OOOUSDT.P 에서 숏 리스크관리 권장

2) 파싱 규칙
- "Binance :" 뒤의 토큰에서 심볼 문자열을 추출한다. (예: OOOUSDT.P)
- 앞뒤 공백 제거(trim) + 제어문자 제거(sanitize) + 대문자 변환(upper)
- 접미 ".P"는 제거한다. (예: OOOUSDT.P → OOOUSDT)
- **주의: 리스크관리 신호는 `.P` 제거 후에** 주도마켓 심볼 매핑 규칙(특수문자 검사 포함)을 적용한다.

3) 심볼 정규화/검증
- 정규화된 심볼이 USDT-M Futures(exchangeInfo)에 존재하는지 확인한다.
- 심볼 상태가 TRADING이 아니면 제외한다.
- 검증 실패 시 해당 리스크관리 신호는 **무시**하고 상태 변화 없이 종료한다.



# === 자동매매 참고사항 ===
※ 로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.


1.상기했듯 -1002171239233 채널에 진입신호 (트레이딩뷰 웹훅 얼러트) 가 수신되면 그 안에 있던 파이썬 봇이 자동으로 주도마켓을 분석해 메시지 하나를 더 보내는 방식이다. 따라서 진입신호와 주도마켓은 연속적으로 붙어있는 경우가 많다.
   - 진입신호는 3분봉 마감 시점에 수신되며, 주도마켓 메시지는 해당 진입신호 직후에만 전송된다. (별도 주기 방송 없음)



ex) 

A코인 진입신호
A코인 주도마켓 분석메시지



2.그러나 가끔 2개 이상의 진입신호가 중복으로 수신되는 경우


**A코인 진입신호**
**B코인 진입신호**
**A코인 주도마켓** 
**B코인 주도마켓**



위와 같은 상황처럼 순서가 살짝 꼬이는 상황이 발생할 수 있다.


따라서 자동매매에서는 "진입신호" 가 아닌 "주도마켓 메시지" 데이터를 "진입 전 공통 필터링 조건식의 트리거" 로 간주하고 진입 전 필터링을 수행 할 것 이다.


즉 , 실질적인 필터링의 시작은 진입신호 메시지가 아닌 주도마켓 메시지가 수신되어야 비로소 "진입 전 공통 필터링 조건식 체크" 기능이 활성화 되는 것 이다.



1) 진입 판단 트리거는 오직 ‘주도마켓 메시지(🔥 실시간 주도 마켓 분석 …)’이다.
진입신호(💥 …) 메시지는 자동매매 로직에서 어떠한 판단 근거로도 사용하지 않는다.

2) 주도마켓 메시지에서 심볼, 펀딩비, 24H 등락(상승/하락) 및 순위, 카테고리를 추출한 뒤, 공통 필터링 조건을 수행한다.
(4개의 필드 중 하나라도 파싱 실패 또는 ‘정보없음’ 포함 시:)
  - 해당 심볼이 **모니터링/미체결 주문/보유 포지션 상태**라면 **무시**하고 기존 상태를 유지한다.
  - 그 외(아직 공통조건 통과 전 단계)라면 **진입 대상에서 제외하고 초기화**한다.

3) 동일 심볼에 대해 아래 상태 중 하나라도 해당되면, 새로 수신된 주도마켓 메시지는 무시한다.

A.해당 심볼이 이미 타점 모니터링 중
B.해당 심볼에 대해 진입 주문이 이미 제출됨 (미체결 포함)
C.해당 심볼의 포지션을 보유 중

3-1) **전역 규칙(ENTRY_LOCK)**: 활성화된 포지션이 **있거나**, **계정 전체(봇/수동 포함) 미체결 주문(진입/청산 구분 없음)** 이 **하나라도 존재하면**
     신규 주도마켓 메시지는 **심볼과 무관하게 전부 무시**한다.
     (모니터링 신규 등록도 허용하지 않는다.)
     - 역할: **신규 주도마켓 메시지 수신 단계(입구)를 차단**하는 규칙
     - 전역 차단으로 입구에서 무시된 메시지는 **쿨다운 타임스탬프를 기록/갱신하지 않는다.**
     - **ENTRY_LOCK은 영구잠금이 아니다.** 미체결 주문을 TTL로 자동 취소/자동 해제하지 않는다.
     - **ENTRY_LOCK 해제 조건**: 포지션 없음 + 계정 전체 미체결 주문 없음
     - 아래의 가격소스 장애 잠금(**SAFETY_LOCK**)과는 별개 상태이며, 최종 입구 차단 조건은 `ENTRY_LOCK OR SAFETY_LOCK` 이다.

4) 동일 심볼의 주도마켓 메시지는 최근 COOLDOWN_MINUTES분 이내에 **수신된 이력**이 있으면, 현재 상태(모니터링/주문/포지션)와 무관하게 무시한다. 
   (쿨다운 타임스탬프는 **수신 시점 기준**으로 기록한다.)
   - TICKER 파싱 성공으로 **심볼이 특정된 경우에만** 쿨다운 기록
   - 필드 파싱 실패라도 심볼이 특정됐다면 쿨다운 기록
   - TICKER 파싱 실패로 심볼이 특정되지 않으면 쿨다운 기록 없음
(기본값 COOLDOWN_MINUTES = 10, config에서 수정 가능)



3.모든 기준은 3분봉 데이터를 활용한다. 진입신호와 리스크관리 신호 또한 3분봉이 기준이다.



4.자동매매 프로그램 코딩시 신호를 수신하는 텔레그램 채널과 리스크관리 신호 수신채널은 config 모듈에서 언제든 바꿀 수 있도록 설계해야한다.

5.**텔레그램 중복/과거 메시지 방지 규칙**
   - 채널별로 마지막 처리한 `message_id`를 저장한다.
   - 새 메시지 수신 시 `message_id`가 **마지막 처리 id 이하이면 무시**한다. (재접속/중복 수신 방지)




# === 자동매매 공통 조건식 (설정된 모드의 영향을 받지 않는 공통 필터링 조건식) ===
※ 로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.



0.해당 섹터는 **자동매매 공통 필터링 조건식** 에 관한 섹터이다. 타점 진입시 사용자는 공격적,보수적 모드를 사전 설정하여 봇의 진입성향을 설정할 수 있다.



1.진입모드에 따른 조건식은 서로 다르므로 , 각 모드별 진입조건식에 대해서는 잠시 미뤄둔 뒤 현재 섹터에서는 모드에 구애받지 않는 **공통 필터링 조건식** 에 대해서 서술할 것 이다.



2.주도마켓 메시지가 수신된 시점을 기준으로 카테고리에 Meme , Defi , Pump.fun , DEX (또는 탈중앙화 거래소) , Binance Alpha Spotlight 키워드가 포함되어 있는 경우 모드에 관계 없이 진입 대상에서 제외한다.
(카테고리 키워드 매칭은 대소문자를 구분하지 않는다.)

(간혹 카테고리에 정보없음 이라는 메시지도 있을텐데 이 경우 또한 진입 대상에서 제외한다.)



3.주도마켓 메시지가 수신된 시점을 기준으로 상승률이 (상승) 상위 10위 안쪽인 경우 진입 대상에서 제외한다. (상승 1위부터 10위까지 진입x 11위부터 진입o)  **단 ,  (하락) 상위의 경우 순위에 관계없이 진입한다.**



4.주도마켓 메시지가 수신된 시점을 기준으로 펀딩비가 -0.1% **이하** 인 경우 진입대상에서 제외한다. **(이상과 이하를 헷갈리지 말 것. 펀딩비 음수가 커질수록 숏포지션은 피해야한다는 철학이다.)**



5.공통 필터링 조건식에서 통과한 종목의 경우 **모드 선택 단계** 로 넘어간다.











# === 포지션 진입 (공격적 모드) ===
※ 로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.



0.해당 섹터는 사용자가 공격적 모드를 설정하고 모드 선택단계에 돌입한 종목의 경우 진입하는 타점의 조건식에 관한 섹터이다.



1.공격적 모드의 경우 상기했듯 **진입신호가 3분봉 마감 시점에 수신될 때** 주도마켓 신호가 수신되므로 신호가 수신된다면 공통조건 필터링을 진행 , 모드 선택 단계로 전환 , 이것까지 통과했다면  **타점 모니터링 모드** 를 활성화한다. 이 경우 , 예상진입 타점은 **신호 수신 시점의 직전 확정 3분봉 고점** 이다.




=== 포지션 진입 (보수적 모드) ===



0.해당 섹터는 사용자가 보수적 모드를 설정하고 모드 선택단계에 돌입한 종목의 경우 진입하는 타점의 조건식에 관한 섹터이다.



1.보수적 모드의 경우 상기했듯 **진입신호가 3분봉 마감 시점에 수신될 때** 주도마켓 신호가 수신되므로 신호가 수신된다면 공통조건 필터링을 진행 , 모드 선택 단계로 전환 , 이것까지 통과했다면  **타점 모니터링 모드** 를 활성화한다. 이 경우 , 예상진입 타점은 **신호 수신 시점의 직전 확정 3분봉 ATR 밴드 상단(Upper Band)** 이다. (숏 기준이므로 하단이 아닌 상단을 사용)





## ※ 진입 예상 타점은 indicator.py 모듈에서 각각 신호 수신 시점의 직전 확정 3분봉 고점과 ATR 밴드 상단(Upper Band)을 가져올 수 있다.
## ※ ATR Upper Band의 파라미터(기간/배수/소스/캔들 정리 개수)는 **indicator.py 구현을 단일 소스로** 사용한다. (문서에 별도 고정값 명시하지 않음)
## ※ 타점은 신호 수신 시점의 직전 확정 3분봉 기준으로 **고정**되며, 모니터링 중 신규 3분봉이 마감되어도 갱신하지 않는다.

## 보수적 모드와 공격적 모드의 차이는 타점에 있다.







# === 포지션 진입 비중과 레버리지 , 그리고 포지션 진입 모드에 관하여 ===
※ 로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.



1.**모드별 선택 단계** 를 통과한 코인이 감지될 경우 , 해당 종목은 **타점 모니터링 모드** 로 진입한다. 이 단계에서는 **계정 전체 주문 취소/레버리지/마진 모드 변경을 수행하지 않는다.**



2.0.1% 알고리즘 트리거가 **충족된 직후(진입 주문 제출 직전)** 아래 순서로 처리한다.
   A) 해당 종목의 레버리지 1배율 및 **마진 모드(Isolated)** 변경을 시도
   B) 변경 실패의 원인이 **해당 종목의 미체결 주문**인 경우에만 Open Orders를 모두 취소
   C) 레버리지/마진 모드 변경을 재시도
   D) 변경 성공 후 진입 주문 제출
다른 심볼의 Open Orders는 취소하지 않는다.
   - 재시도 후에도 실패하거나, 실패 원인이 미체결 주문이 아닌 경우에는 **로그 기록 후 해당 심볼 상태를 초기화**하고 주문을 제출하지 않는다.



3.레버리지 1배율과 격리모드는 유동적으로 변화하는 요소가 아닌 고정적인 요소이다.



4.해당 종목이 이미 레버리지가 1배율이고 격리모드인경우 이 과정은 스킵한다.



5.**포지션 모드(Position Mode: ONE-WAY/HEDGE)** 는 사용자 계정 설정을 존중한다. 거래 시작 전 및 주문 직전에 계정 모드를 조회한다. HEDGE 모드이면 모든 주문에 positionSide=SHORT를 명시한다. ONE-WAY이면 positionSide를 전송하지 않는다. 조회 실패 또는 모드 불명확 시 해당 심볼 주문을 금지하고 상태를 초기화한다.



6.모드에 관계없이 진입비중은 2분할 진입이 원칙이다. **USDT-M 선물 지갑(선물 계정) USDT 잔고**의 50%가 첫진입이며,
  이후 추매는 **선물 지갑의 가용(available) USDT** 기준으로 산출한다.
  - 2차 진입 자금 = available USDT * (1 - MARGIN_BUFFER_PCT)
  - MARGIN_BUFFER_PCT는 수수료/예약/PNL 변동 여유 버퍼 (예: 0.5~2%, config로 조정)



7.추매의 조건식은 모드에 관계없이 1차 진입 후 평단으로부터 +15% 떨어진 구간에 0.1% 알고리즘을 적용하여 투입한다. 또한 15%라는 수치는 config 모듈에서 수정할 수 있도록 한다. (0.1% 알고리즘이 무엇인지는 이후 설명한다.)







=== 0.1% 알고리즘이란 무엇인가? ===



1.0.1% 알고리즘이란 , 많은 사람이 비슷한 타점에 진입되는 자동매매 프로그램이니만큼 세력의 호가창 분석과 슬리피지를 최소화 하기 위한 일종의 **CCTV 알고리즘** 이다. **타점 모니터링 모드** 에 돌입한 코인을 Binance web socket 을 통해 실시간 가격을 추적하며 목표가에 0.1%만큼 근접했을 때 목표가에 주문을 넣는 방식을 의미한다. 이는 진입 뿐만 아니라 **익절** 에서도 동일하게 작용할 것 이다.



1-1.쉽게 말해 미리 주문을 걸어두지 않고, 가격을 CCTV처럼 감시(Binance WebSocket 이용)하다가 목표가에 아주 근접했을 때(0.1% 전) 순식간에 주문을 넣는 방식인 것 이다.

1-2.**숏 기준 트리거 방향 정의**

A) 숏 1차 진입: 진입예정가를 P1이라 할 때, 현재가가 P1 * (1 - 0.001) **이상(>=)** 이면 P1에 지정가 진입 주문 제출.
   예시: P1=1.0 → 트리거 0.999 도달 시 1.0에 주문 제출.
B) 숏 2차 진입: 1차 평단을 Pavg라 할 때, 2차 목표가 P2 = Pavg * (1 + 추매퍼센트). 현재가가 P2 * (1 - 0.001) **이상(>=)** 이면 P2에 지정가 진입 주문 제출.
   예시: Pavg=1.0, 추매퍼센트=15% → P2=1.15, 트리거 1.14885.
C) 숏 1차 진입 이후 익절(TP): TP 목표가를 Ptp라 할 때, 현재가가 Ptp * (1 + 0.001) **이하(<=)** 이면 Ptp에 지정가 청산 주문 제출.
   예시: Pavg=1.0, TP=5% → Ptp=0.95, 트리거 0.95095.
D) 숏 2차 진입 **체결 발생 이후(부분체결 포함)** 본절 청산: 본절 목표가 Pbe(평단) 기준, 현재가가 Pbe * (1 + 0.001) **이상(>=)** 이면 Pbe에 지정가 청산 주문 제출.
   예시: Pbe=1.2 → 트리거 1.2012.
E) 트리거 조건이 최초 평가 시점에 이미 만족되어 있으면 대기 없이 즉시 주문을 제출한다. (재접근 대기 없음)
F) 트리거 가격이 **1초 평가 간격 사이에 일시적으로 스치고 지나갔는지 여부는 판단하지 않는다.**
   - 판단 기준은 **각 1초 평가 시점의 현재가**이다.
   - 따라서 현재가가 트리거 조건을 만족하지 않으면 **계속 대기**한다. (스킵 감지로 인한 초기화/즉시 주문 없음)

1-3.**가격 소스 정의 (0.1% 알고리즘/PNL 공통)**
- 0.1% 알고리즘의 트리거 “현재가”와 PNL 판정은 **Mark Price** 기준으로 통일한다.
- WebSocket은 USDT-M Futures Mark Price Stream(<symbol>@markPrice@1s)의 p(markPrice) 값을 사용한다.
- WebSocket 지연/끊김 시 REST /fapi/v1/premiumIndex의 markPrice로 폴백한다.
  - 기준: WebSocket 최신 수신 시각 기준 **5초 이상 미수신**이면 폴백 모드로 전환한다.
  - 폴백 중에는 REST로 markPrice를 **1초 주기**로 갱신한다. (동일 1초 평가 루프 유지)
  - WebSocket이 재수신되면 즉시 복귀한다.
  - 폴백 전환/복귀 시각과 **끊김 사유(연결 종료/타임아웃/예외 메시지 등)** 를 로그로 남긴다.
- **가격 소스 스테일/이중 장애 처리**
  - `STALE_MARK_PRICE_SECONDS` 동안 **WebSocket 미수신 + REST 최신 markPrice도 스테일**이면 가격 소스 장애로 판단한다.
  - 즉시 **가격소스 안전잠금(SAFETY_LOCK)** 진입: 신규 신호/모니터링/주문 전부 금지.
  - **포지션 보유 중**이면 즉시 **시장가 전량 청산**한다. (계정 모드 파라미터 규칙 적용)
  - **포지션 없음 + 모니터링/미체결 주문 상태**이면 모든 모니터링 해제 + 미체결 주문 취소 후 상태를 초기화한다.
  - 최신 markPrice가 정상 수신되면 **SAFETY_LOCK만 해제**한다. (상태는 초기화 유지)
  - 이때 **ENTRY_LOCK 조건(포지션/미체결 주문)** 이 남아 있으면 입구 차단은 유지된다.
- **PNL(ROI) 정의**
  - PNL 판단은 Binance 웹에 표시되는 **ROI(수수료 미포함)** 기준으로 한다.
  - 숏 포지션 ROI(%) = (평단 - MarkPrice) / 평단 * 100
  - 복수 체결 시 평단은 **포지션 평균 진입가**를 사용한다.
  - PNL 분기(PNL < 0 / = 0 / > 0)는 **ROI(%)의 부호**로 판단한다.
  - **PNL = 0은 ROI가 정확히 0%일 때만** 인정한다. (허용오차 없음)

2.진입주문은 모드에 관계없이 **지정가 진입** 을 사용해야 한다.



3.프로그램을 사용하는 사용자가 많을 것 이므로 시장가를 이용하면 필연적으로 슬리피지가 발생할 것 이다.



4.필터링에 통과함과 동시에 주문을 넣어야 하는 상황이 있을 수 있다. (신호가 오자마자 거의 바로 타점에 도달하는 경우) 이 경우에도 똑같이 **지정가** 주문을 사용한다.



4-1.만약 조건식이 전부 맞아 떨어져서 진입해야하는 가격이 $1.0 인데 현재 가격이 $1.1 이라면 그래도 여전히 $1.0에 **지정가 주문** 을 제출해야 한다. 시장가를 사용하면 슬리피지가 생길 수 있기 때문이다. 지정가 숏포지션 오픈 주문을 현재 가격보다 낮은곳에 제출하게 되면 적어도 $1 아래로는 체결되지 않으므로 슬리피지를 방지할 수 있다.

4-2.**트리거 충족 후 주문 제출 실패 처리**
- 동일 주문을 **최대 3회까지 재시도**한다. (간격/백오프는 구현에서 설정)
- 3회 실패 시 해당 이벤트는 로그로 기록하고 아래처럼 처리한다.
  - **1차 진입 주문**: 해당 심볼 상태를 초기화한다.
  - **2차 진입 주문**: **2차 진입만 스킵**하고, 현재 포지션 상태(PHASE1/PHASE2)는 유지한다.
  - 단, 실패 사유가 **INSUFFICIENT_MARGIN** 인 경우:
    - **1차 진입**: 재시도 없이 즉시 로그 기록 후 해당 심볼 상태를 초기화한다.
    - **2차 진입**:
      1) available USDT 재조회
      2) MARGIN_BUFFER_PCT 재적용 후 수량 재계산
      3) LOT_SIZE 정규화 후 재시도
      - 재시도 실패 시 **2차 진입 스킵** + 로그 기록 + 현재 포지션 상태 유지

4-3.**진입 주문 파라미터 고정값**
- 진입 지정가 주문은 `timeInForce=GTC`로 고정한다. (TTL 없음)
- 진입 주문은 **reduceOnly 사용 금지(또는 false)** 로 제출한다.
- 주문 재시도 시 **동일한 `newClientOrderId`** 를 사용하여 중복 주문을 방지한다.





# === 주문 가격/수량 정규화 규칙 (거래소 필터 적용) ===
※ 로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

0.모든 주문(진입/추매/익절/손절/본절)은 Binance USDT-M exchangeInfo 필터를 적용한다.

1.가격 정규화(PRICE_FILTER.tickSize):
- 계산된 가격 P는 tickSize 단위로 **반올림**하여 P_adj = round(P / tickSize) * tickSize 로 정규화한다.
- 적용 대상: **진입/청산 LIMIT 가격, STOP/STOP_MARKET의 stopPrice** 모두 동일 적용
- 정규화 후 가격이 0 이하이면 해당 주문은 금지한다.

2.수량 정규화(LOT_SIZE.stepSize/minQty):
- 계산된 수량 Q는 stepSize 단위로 **내림**하여 Q_adj = floor(Q / stepSize) * stepSize 로 정규화한다.
- Q_adj < minQty 이면 해당 주문은 금지하고, 사유를 기록한 뒤 아래처럼 처리한다.
  - **1차 진입 주문**: 해당 심볼 상태를 초기화한다.
  - **2차 진입 주문**: **2차 진입만 스킵**하고, 현재 포지션 상태(PHASE1/PHASE2)는 유지한다.

3.(존재 시) 최소 주문금액(MIN_NOTIONAL 등) 규칙을 만족하지 못하면 해당 주문은 금지하고 아래처럼 처리한다.
  - **1차 진입 주문**: 해당 심볼 상태를 초기화한다.
  - **2차 진입 주문**: **2차 진입만 스킵**하고, 현재 포지션 상태(PHASE1/PHASE2)는 유지한다.

3-1.청산 주문(TP/본절/스탑) 필터 실패(PRICE_FILTER/LOT_SIZE/MIN_NOTIONAL) 시:
  - 실패 사유와 주문 파라미터를 반드시 로그로 기록한다.
  - 보유 포지션 수량이 minQty 이상이면 **시장가 청산을 1회만 시도**한다.
  - 보유 포지션 수량이 minQty 미만이면 **dust 처리 후 상태를 초기화**한다. (청산 주문 재제출 없음)

4.0.1% 알고리즘의 트리거 계산은 **정규화된 목표가(P_adj)** 를 기준으로 한다.

예시) 
- tickSize=0.1, 목표가 P=1.03 → P_adj=1.0
- stepSize=0.001, minQty=0.01, 계산 수량 Q=0.0075 → Q_adj=0.007 → minQty 미달로 주문 금지





# === 주문 체결 상태 정의 ===
※ 로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

1) 미체결: 주문 제출 후 체결 수량 q1=0 인 상태 (주문 상태 NEW/OPEN).
2) 부분체결: 주문 상태 PARTIALLY_FILLED, 1차 진입 주문의 목표 수량 Q1 중 실제 체결 수량 q1이 0 < q1 < Q1 인 상태.
3) 완전 체결: 주문 상태 FILLED, q1 = Q1 인 상태. (1차 진입 완료)

※ 2차 진입 주문도 동일한 미체결/부분체결/완전체결 개념을 적용한다.
   - 단, 2차 **부분체결 발생 즉시 Phase2(본절 우선 모드)** 로 전환한다.




# === 타점 모니터링 리스트 현황판 ===
※ 로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.



1.타점 모니터링 리스트는 공통 필터링 조건과 모드별 필터링 조건을 모두 만족하여 타점을 모니터링 하고있는 종목들의 리스트를 표시하는 판이다.



2.종목 / 필터링 성향 / 상태 / 진입 예정가 로 나뉘어져 있으며 예시는 아래와 같다.



## 예시 => BTC / 보수적 or 공격적 / 1차진입 or 2차진입 / 진입 예정가



3-0.동일 타임슬롯에 2개 이상 종목이 0.1% 알고리즘 트리거를 동시에 만족하면 아래 Tie-break 규칙으로 **결정적으로 1종목만** 주문을 제출하고 나머지는 즉시 초기화한다.
   - 여기서 “동일 타임슬롯”은 markPrice@1s 기준 **동일 1초 평가 주기(동일 평가 루프)** 를 의미한다.
   - 역할: **이미 모니터링 중인 종목 간 동시 진입 충돌을 해결**하는 규칙
   - 본 규칙은 **무작위 선택을 사용하지 않는다. (deterministic)**
   - **수신 시각 기준**: 텔레그램 원본 `date`가 아니라, **우리 봇이 실제로 해당 메시지를 수신한 로컬 시각**(`received_at_local`)을 사용한다.
   - **Tie-break 규칙**: `received_at_local`이 더 늦은 종목을 우선 선택한다.
     - 수신 시각이 같으면 **message_id가 더 큰** 종목을 선택한다.
   - 재시작/복구 시 일관성을 위해 심볼별 `received_at_local`은 `message_id`와 함께 영속 저장하고 복원한다.

3.만약 모니터링 중이던 1차진입 타점 중 하나가 0.1% 알고리즘에 의해 주문이 제출된 경우 해당 종목만 남기고 나머지 모니터링중이던 종목들은 모니터링 대상에서 삭제 , 완전히 초기 단계로 되돌린다.



3-1.1차 진입된 상태가 추매로 인해 업데이트 될 경우에는 종목을 삭제하지 않고 상태와 진입 예정가를 그에 맞게 업데이트 한다.



4.모니터링중이던 타점 중 하나가 1차 진입 주문 **완전 체결(FILLED)** 된 경우 해당 종목의 상태는 1차 진입에서 2차 진입으로 , 또 평단에 따라 진입 예정가를 새로 업데이트 한다.

4-1.**1차 진입 주문** 부분체결(PARTIALLY_FILLED) 상태에서는 2차 진입 모드로 전환하지 않으며, TP 0.1% 알고리즘을 활성화한다. 트리거 도달 시 **현재 보유 포지션 전량**에 대해 TP 지정가 청산 주문을 제출한다. 평균가 변경 시 TP 주문을 취소 후 재등록한다.

4-2.진입 주문이 부분체결 상태인 동안 **잔여 진입 주문은 유지**한다. (만료 없음)
단, 리스크관리 신호가 수신되면 잔여 진입 주문을 즉시 취소하고, 현재 포지션의 PNL 규칙을 적용한다.
(PNL < 0: 시장가 전량 청산 / PNL = 0: 시장가 즉시 청산 / PNL > 0: **Phase1 기준 본절 스탑 + TP 유지**)

4-3.**2차 진입 주문**이 부분체결되면 **즉시 Phase2(본절 우선 모드)** 로 간주한다.
   - **수익 TP 주문은 비활성화**하고, 본절 청산 목표를 **평단 기준 0.1% 지정가**로 전환한다.
   - 2차 체결로 **평단이 변경될 때마다** 본절 청산 주문은 취소 후 재등록한다.
   - **Phase2 전환(2차 체결 발생) 시 기존 수익 TP 주문이 존재하면 즉시 취소**하고, **본절 0.1% 지정가 청산만 유지**한다.
   - **잔여 2차 진입 주문은 유지**한다. (추가 체결 가능)
   - **본절 청산 트리거 발생 시** 잔여 2차 진입 주문은 **즉시 취소**하고 본절 청산을 진행한다.
   - MDD 스탑로스는 **2차 전량 체결 시점에만** 제출한다.



5.이미 포지션이 있거나 타점을 모니터링중인 종목이 있는 경우 MDD값 , TP RATIO , 종목 필터링 성향 등은 수정할 수 없도록 해야한다.







# ===  포지션 진입 전 프로세스 중간점검 및 예상 시나리오 ===
※ 로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.



0.해당 섹터는 신호 수신 후 자동매매 프로그램이 진입을 결정 및 실제 진입주문 제출까지의 워크플로우를 다룬다.



1.-1002171239233 채널에 🔥 실시간 주도 마켓 분석 신호가 수신된다.



2.자동매매 프로그램은 🔥 실시간 주도 마켓 분석 메시지에서 ⏱️Binance 펀딩비 및 카운트다운 : N.NNNN% / hh:mm:ss (4h) , 🥇지난 24H 등락률 및 순위 : +NN.NN% / (상승 또는 하락) 상위 N위 , 🏷️카테고리 : (OOO코인의 카테고리) 3가지의 데이터를 추출한다.



================================



A.초기화 시나리오 (신호 발생 전 상태로 복귀)



신호가 발생했으나 조건 미달로 인해 프로세스를 종료하는 것이 아니라, 해당 종목의 상태를 신호 발생 전으로 되돌린다.



시나리오 A: 포지션 중복으로 인한 신호 무시



[1. 신호 발생] 및 마켓 데이터 수신

[2. 포지션 확인] 진입 중인 포지션이 하나라도 있는지 확인 → 있음 (O)


[결과] 발생 신호 무시 (시스템은 계속 다른 진입신호 (주도마켓) 수신을 대기하는 상태 유지)



================================



시나리오 B: 공통 필터링 미충족으로 인한 초기화



[1. 신호 발생] 및 마켓 데이터 수신

[2. 포지션 확인] 진입 중인 포지션이 있는지 확인 → 없음 (X)

[3. 공통 필터링] 조건 실행 → 통과 실패 (X)



[결과] 해당 종목은 신호 발생 전 상태로 초기화 (리셋)



================================



2. 병렬 모니터링 진입 시나리오 (타점 대기 풀 등록 및 모니터링 리스트에 등록)



모든 필터링을 통과한 종목이 **0.1% 알고리즘** 을 장착하고 **타점 감시 리스트(병렬 풀)** 에 등록 및 시각화 (여기서 시각화란 타점 모니터링 판넬을 의미한다.) 되는 과정이다.
단, 이 병렬 모니터링은 **활성 포지션이 없고 미체결 주문도 없는 상태에서만** 허용된다.



[공통 선행 프로세스]



신호 및 필터링: 신호 발생 → 포지션 없음 → 공통 필터링(O) → 모드선택단계로 전환

주문 정리: 이 단계에서는 **주문 취소를 수행하지 않는다.** (주문 정리는 0.1% 트리거 충족 직후, 해당 종목에 한해 수행)

환경 설정: 레버리지/마진 모드 변경은 **타점 모니터링 단계가 아닌**, 0.1% 트리거 직후(주문 직전) 단계에서 수행한다.
(이미 1배율, 격리모드가 설정되어 있을시 스킵)

알고리즘 가동: 0.1% 알고리즘을 적용하여 **모드에 따른** 타점 모니터링 시작

이후 **설정된 모드에 따라** 병렬 모니터링 대기열에 다음과 같이 추가됩니다.



================================



시나리오 D: 보수적 모드 (Conservative) 대기열 등록



상태: 병렬 모니터링 진행 중 (다른 종목들과 함께 감시)

적용 알고리즘: 0.1% 알고리즘 + 보수적 모드 로직

타점 기준: indicator.py에서 계산된 [신호 수신 시점의 직전 확정 3분봉 ATR 계산값]

행동: 현재가가 ATR 계산값에 도달하는지 실시간 감시 (체결 전까지 대기)



================================



시나리오 E: 공격적 모드 (Aggressive) 대기열 등록



상태: 병렬 모니터링 진행 중 (다른 종목들과 함께 감시)

적용 알고리즘: 0.1% 알고리즘 + 공격적 모드 로직

타점 기준: indicator.py에서 출력된 [신호 수신 시점의 직전 확정 3분봉 고점]

행동: 현재가가 직전 3분봉 고점에 도달하는지 실시간 감시 (체결 전까지 대기)



================================



# === 모니터링 취소 조건식 ===
※ 로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.


0.당연하겠지만 **모든 사전 필터링이 끝나고 타점을 모니터링 하는 중에** 주문을 취소해야하는 상황이 있을 것 이다. (체결되지 않고 가버리는 경우)

1.만약 특정 코인이 **타점 모니터링 모드** 상태면서 해당 코인이 텔레그램 채널 -1003096527269 에서 리스크관리 신호가 수신되는 경우 해당 코인은 모니터링을 해제하여 완전히 처음 상태로 되돌려야 한다. (공통 필터링 이전으로 완전 초기화)

2.리스크관리 신호는 **해당 심볼**에 한해 처리한다.
   - 해당 심볼이 타점 모니터링/미체결 주문/보유 포지션 중 **어느 상태도 아니면** 리스크관리 신호를 무시한다.
   - 보유 포지션이 있더라도 **다른 심볼**의 리스크관리 신호는 무시한다.

3.만약 특정 종목이 **타점 모니터링 상태** 를 넘어 실제로 주문이 제출되었으나 포지션이 없는 상태에서 **리스크관리** 신호가 수신된 경우 (즉 , 진입은 시도했으나 체결되지 않은 경우) 미체결주문을 전부 취소해야한다.

4.리스크관리 신호가 수신되지 않은 경우, 미체결/잔여 진입 주문은 **만료(TTL) 없이 유지**한다. (자동 취소/재주문 없음)
단, 0.1% 트리거 충족 직후 **해당 종목에 한해** 레버리지/모드 변경을 위해 Open Orders 취소가 실행될 경우 해당 미체결 주문은 취소될 수 있다.
   - 정책: **ENTRY_LOCK은 영구잠금이 아니다.** 미체결 주문은 TTL로 자동 취소/자동 해제하지 않는다.
   - 해제 조건: 포지션 없음 + 계정 전체 미체결 주문 없음일 때만 ENTRY_LOCK을 해제한다.
   - 전제: 리스크관리 신호는 주도마켓(진입신호) 발생 이후 **필연적으로 수신**된다는 운영 전제
   - 운영 범위: 리스크관리 신호 미수신(누락/지연) 시나리오는 운영 범위에서 제외한다.
   - 구현 범위: 따라서 미체결 주문 TTL 타임아웃/운영자 강제 해제(unlock/reset) 로직은 구현하지 않는다.

5.**계정 전체(봇/수동 포함) 미체결 주문(진입/청산 구분 없음)** 이 존재하거나 **포지션이 1개라도 체결된 시점부터**는 해당 심볼에만 집중한다.
   - 다른 심볼의 **신규 주문(진입/청산)** 은 모두 금지한다.
   - 다른 심볼의 신규 모니터링/신호 처리도 중단한다.



================================


# === 추가매수 관련 프로세스 ===
※ 로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

0.타점을 모니터링중이던 종목 중 한 종목의 **진입 주문이 실제로 제출될 경우** 다른 모니터링중이던 모든 종목들은 초기화 (공통 필터링 이전으로 리셋) 하며 **타점 모니터링 판넬** 에서도 제거한다.

1.만약 1차진입 포지션이 **완전 체결(FILLED)** 되었다면 0.1% 알고리즘을 평단으로부터 +15% 떨어진 곳으로 전환한다. (타점 모니터링 판넬의 상태가 1차가 아닌 2차가 되는 경우)

2.2차 진입 주문이 **부분체결 이상** 발생하면 즉시 **Phase2(본절 우선 모드)** 로 간주한다.
   - **수익 TP는 비활성화**하고, 본절 청산 목표를 **평단 기준 0.1% 지정가**로 전환한다. 평단이 변하면 본절 청산 주문을 취소 후 재등록한다.
   - 잔여 2차 진입 주문은 유지한다.

2-1.2차 진입이 **전량 체결**되었다면 비로소 사용자가 설정한 MDD값에 따른 스탑로스 주문을 제출한다.

3.스탑로스 주문이 제출되었다면 2차 진입까지 체결된 상태일 것 이므로 **수익 TP는 비활성화**하고 **본절(평단)에 0.1% 알고리즘** 을 적용하여 본절에 모든 포지션을 청산하여 나가는것을 목표로 한다.


## 추가매수 워크플로우 예시

1.A코인과 B코인이 타점 모니터링 상태면서 A코인이 먼저 0.1% 알고리즘 트리거가 작동했다면 (주문이 제출되었다면) 자동으로 B코인은 타점 모니터링 리스트에서 제거 후 공통 필터링 이전으로 초기화 한다.

2.A코인의 진입주문이 **전부** 체결되었을 경우 평단으로부터 +15% 떨어진 가격대에 지갑에 남은 모든 물량을 투입할 준비를 한다. (이 또한 마찬가지로 0.1% 알고리즘을 적용한다.)

3.만약 2차 진입이 체결되어 모든 시드를 활용중인 경우 1순위로 평단에 모든 물량을 털어내는것을 목표로 하며 리스크관리 신호와 **본절**의 0.1% 알고리즘 모드를 항시 대기한다.
# === 청산 (손절,익절)관련 프로세스 ===
※ 로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

0.익절/손절/본절 등 모든 청산 주문은 아래 규칙에 따라 제출한다. 포지션이 없는 상태에서는 청산 주문을 제출하지 않으며, 잔존 청산 주문이 있으면 즉시 취소한다.
   - 시장가 사용 예외(총 5가지):
     1) 리스크관리 신호 + PNL ≤ 0
     2) 지정가 청산 주문 거절 시 시장가 폴백
     3) 청산 주문 PARTIALLY_FILLED 후 5초 정체 시 잔량 시장가 청산
     4) 가격 소스 스테일/이중 장애(WS 미수신 + REST markPrice 스테일)로 SAFETY_LOCK 진입 시, 포지션 보유 중이면 시장가 전량 청산
     5) 청산 주문 필터 실패(PRICE_FILTER/LOT_SIZE/MIN_NOTIONAL) 시, 보유 포지션 수량이 minQty 이상이면 시장가 청산 1회 시도
   - 별도 스탑 규칙(시장가 직접 청산 예외 집계와 분리): **Phase1에서 리스크관리 + PNL > 0** 케이스의 본절은 STOP_MARKET으로 제출

0-0.청산 주문 파라미터 규칙 (ONE-WAY/HEDGE)
- ONE-WAY: 지정가 TP/기타 청산 주문은 reduceOnly=true로 제출한다.
- ONE-WAY: STOP_MARKET/TAKE_PROFIT_MARKET 청산 주문은 closePosition=true로 제출한다. (quantity 미사용)
- HEDGE: 지정가 TP/기타 청산 주문은 positionSide=SHORT를 명시하고 quantity로 제출한다. (reduceOnly 미사용)
- HEDGE: STOP_MARKET/TAKE_PROFIT_MARKET 청산 주문은 positionSide=SHORT + closePosition=true로 제출한다. (quantity 미사용)

0-2.청산 주문 안전 규칙 (HEDGE/ONE-WAY 공통 적용)
- 주문 직전에 포지션 모드(ONE-WAY/HEDGE)와 positionSide 상태를 확인한다.
- HEDGE 모드에서는 반드시 positionSide=LONG/SHORT를 명시한다.
- 지정가( LIMIT ) 청산 주문이 **오류로 거절**되는 경우에만 즉시 취소하고, **시장가 청산으로 폴백**한다.
  (계정 모드에 따라 ONE-WAY는 reduceOnly=true, HEDGE는 positionSide=SHORT로 시장가 청산 제출)
- 청산 수량은 현재 보유 포지션 수량을 초과할 수 없다. 초과 시 주문을 차단하거나 수량을 포지션 수량으로 강제 보정한다.

0-1.TP-Ratio와 MDD는 모두 **퍼센트(%) 기준** 값이다. 숏 포지션 기준으로 TP 목표가는 평단에서 **아래 방향**, MDD 스탑로스는 평단에서 **위 방향**으로 계산한다.

### 손절
※ 로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

1.손절은 2가지 경우로 작동한다.

A.아래에 후술할 **추가매수가 전부 끝났다면** 사용자가 설정한 MDD값(기본 15%)에 스탑로스 주문을 제출한다. (예: 평단 1.0, MDD 15% → 스탑로스 1.15)

B.현재 내 PNL이 **음수** 인 상태에서 **리스크관리** 신호가 수신되는 경우 시장가로 즉시 전량 청산한다.

### 익절
※ 로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

1.익절은 아래처럼 작동한다.

A.1차진입 **완전 체결(FILLED)** 직후 사용자가 설정한 TP-Ratio(%) 값에 0.1% 알고리즘을 적용한다.

B.부분체결(PARTIALLY_FILLED) 상태에서도 TP 0.1% 알고리즘을 활성화한다. 트리거 도달 시 **현재 보유 포지션 전량**에 대해 TP 지정가 청산 주문을 제출하며, 평균가 변경 시 TP 주문을 취소 후 재등록한다.

예시 → A코인이 평단 1.0 USDT에 **1차 진입이 완료(FILLED)되었고** , 사용자가 설정한 TP-Ratio가 5% 일 때 , 해당 포지션의 타겟은 0.95 USDT 이므로 , 0.1% 알고리즘이 작동하여 익절 지정가 주문을 제출해야하는 가격은 0.95095가 되어야 한다. (0.95095 usdt 도달시 0.95 usdt에 지정가 청산주문 제출)


### 본절로스
※ 로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

1.포지션을 홀딩하고 있는 도중 **리스크관리** 신호가 수신되었다면 현재 포지션의 PNL을 확인 , 만약 PNL이 양수라면 스탑로스를 **현재 포지션의 평단** 에 제출한다.

2.앞서 말했던 **익절의 0.1% 알고리즘** 은 **TP가 활성 상태인 경우에만** 유지한다. (Phase2에서는 본절 알고리즘 유지)

3.즉 , 포지션 PNL이 양수인 상태라면 본절로스를 걸고 **TP가 활성 상태인 경우에만** 추가 수익을 노려보겠다는 철학인 것 이다.

※ 본절 처리 분기 명시
- Case 1) 리스크관리 신호 수신 + PNL > 0 (1차 진입 이후, TP 미도달 구간):
  **본절 스탑로스는 STOP_MARKET으로 제출**한다. (본절가 위에서 체결 대기)
- Case 2) 2차 진입 **체결 발생 이후(부분체결 포함)** 본절 목표:
  **본절 청산은 0.1% 알고리즘의 지정가 청산**을 사용한다. (STOP_MARKET 사용하지 않음)
  - MDD 스탑로스는 **2차 전량 체결 시점에만** 제출




# === 청산/스탑 우선순위 및 상호취소 규칙 ===
※ 로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

[Phase 1: 1차 진입 전량 체결 직후]
- 활성 상태:
  1) 익절(0.1% 알고리즘)은 **리스크관리 신호 수신 전까지** "모니터링"만 수행 (주문은 **트리거 도달 시에만** 제출)
  2) 2차 진입 타점 모니터링 활성화
  3) 리스크관리 신호 상시 대기
- MDD 스탑로스는 이 단계에서는 절대 제출하지 않는다.
- 별도 손절 페일세이프 없음(리스크관리 신호에만 의존)

[Phase 2: 2차 진입 체결 발생 이후(부분체결 포함)]
- **수익 TP(익절) 0.1% 알고리즘은 비활성화**한다.
- **본절 청산(평단) 0.1% 알고리즘은 활성 유지**한다. (지정가 청산)
- 평단 변동 시 본절 청산 주문은 취소 후 재등록한다.
- MDD 스탑로스는 **2차 전량 체결 시점에만** 제출한다.
- 리스크관리 신호 상시 대기

[리스크관리 신호 처리]
- PNL > 0:
  - Phase 1(1차 진입 이후): **STOP_MARKET 본절 스탑 + TP 유지**
    - TP 유지 정의: TP 주문이 이미 있으면 유지하고, TP 주문이 없으면 **현재 TP 목표가로 지정가 주문을 즉시 1회 생성**한다.
    - TP 주문을 즉시 생성한 경우, TP 0.1% **트리거 모니터링은 종료**하고 TP 주문의 상태 모니터링(체결/부분체결/취소/동기화)만 유지한다.
  - Phase 2(2차 체결 발생 이후): **본절 0.1% 지정가 유지** (STOP_MARKET으로 덮어쓰지 않음)
    - MDD가 제출돼 있으면 **유지**
- PNL = 0: 시장가 즉시 청산 (Phase 구분 없음)
- PNL < 0: **시장가 전량 청산 (Phase 구분 없음, 최우선)**

[상호취소(OCO) 규칙]
- TP/본절/스탑 중 하나라도 **완전히** 체결되면 (Filled), 같은 심볼의 잔여 청산 주문은 즉시 취소한다.
- 잔여 청산 주문 취소가 실패하면 **최대 3회 재시도**한다.
  - 3회 실패 시: 해당 심볼은 **신규 주문/진입을 금지**하고, 상태를 “청산 취소 실패”로 표시한다.
  - 이후 주기적으로 Open Orders를 재조회하여 잔여 청산 주문이 남아 있으면 **재취소**를 시도한다.

[동시 발생 우선순위]
- 동일 평가 루프 내에 여러 청산 조건이 동시에 충족되면 아래 우선순위를 적용한다.
  1) 리스크관리 신호 + PNL ≤ 0: 시장가 청산 (최우선)
  2) 스탑류(MDD 스탑로스 / 본절 스탑로스)
  3) TP/본절 0.1% 지정가 청산

[스탑 주문 타입/트리거 기준]
- MDD 스탑로스는 STOP_MARKET 주문으로 제출한다.
- 본절 스탑로스는 **리스크관리 신호 + PNL > 0** 케이스에서만 STOP_MARKET 주문으로 제출한다.
- Phase 2(2차 체결 발생 이후)의 본절 목표는 **0.1% 알고리즘 지정가 청산**을 사용한다.
- 모든 스탑 트리거는 Mark Price 기준으로 설정한다. (workingType=MARK_PRICE)

[청산 주문 부분체결 처리]
- 본 규칙은 TP/본절/스탑 등 **청산 주문에만 적용**하며, 진입 주문에는 적용하지 않는다.
- 주문 상태가 PARTIALLY_FILLED로 최초 전환된 시점부터 5초 동안 추가 체결이 없으면
  해당 주문의 잔량을 취소하고 잔여 수량은 **시장가 청산(ONE-WAY: reduceOnly=true / HEDGE: positionSide=SHORT)** 으로 즉시 청산한다.
- 리스크관리 신호로 인한 시장가 청산이 **동일 루프에 동시에 발생**하면,
  **리스크관리 청산을 우선 실행**하고 부분체결 5초 룰 청산은 생략한다.

[포지션 수량 변경 시 동기화]
- 포지션 수량이 변경되면(수동 청산/강제 청산 포함) 해당 심볼의 모든 청산 주문을 취소한다.
- 현재 포지션 수량 기준으로 **활성 상태인** 청산 주문(TP/스탑 등)만 재등록한다.
- 포지션 수량이 0이 되면 모든 주문을 취소하고 상태를 초기화한다.

[잔여(dust) 처리 규칙]
- stepSize/minQty 정규화 후 잔여 포지션 수량이 minQty 미만이면 해당 잔여는 dust로 간주한다.
- dust는 자동 청산하지 않으며, 상태 머신에서는 **포지션 없음**으로 처리한다.
- dust로 판정된 경우 해당 심볼의 청산 주문은 모두 취소하고 **재등록하지 않는다**.
- dust는 신규 신호 차단 조건(활성 포지션)으로 보지 않는다.


# === 구현 시 유의사항 (예상 오류 체크리스트) ===
※ 로깅: 이 섹션의 입력/판단/결과/상태 전이/실패 사유를 기록한다.

※ 아래 항목은 **명세 규칙과 별개로 구현 단계에서 방어가 필요한 환경/통신/운영 리스크**를 정리한 참고 목록이다.

1) 신호 수신 환경
- 채널 ID/권한 변경, 봇 삭제·읽기 불가
- 메시지 지연/중복/순서 뒤섞임, 진입신호-주도마켓 불일치/누락
- 신호 원본 포맷은 고정이며 변형(이모지 누락/공백/줄바꿈)은 운영 범위에서 제외

2) 시장 데이터/시간
- WebSocket 끊김/지연, markPrice 누락
- REST 폴백 실패·레이트리밋·백오프
- 서버 시간 드리프트(타임스탬프/서명 오류)
  - 서버 시간 드리프트(-1021 등) 시 시간 재동기화 후 동일 요청 재서명/재시도
  - 활성 상태(모니터링/미체결 주문/포지션)면 상태 유지, 비활성 상태는 해당 이벤트 초기화

3) 거래소/HTTP
- API 키 권한 부족(선물/읽기), IP 제한
- 레이트리밋/타임아웃/네트워크 오류
  - 레이트리밋 보호모드 기본값: 연속 실패 5회 진입, 연속 정상 3회 해제 (config에서 조정 가능)
  - 레이트리밋 보호모드 상태 기반: 무포지션은 신규 진입 금지+모니터링 유지, 포지션 보유는 신규 진입 금지+청산 주문 우선 재시도
  - API 키 권한 부족 시 상태 기반 대응: 포지션/미체결 주문 보유 상태는 유지하고 신규 진입만 차단, 무포지션 상태는 이벤트 초기화
  - API 키 권한 부족(`AUTH_ERROR_LOCK`) 진입 시 UI 알림창(팝업)으로 운영자 수동 개입 필요 상태를 즉시 표시

4) 거래소 메타데이터
- exchangeInfo/filters 조회 실패/지연, 캐시 스테일

5) 상태 동기화(운영)
- 수동 청산/강제 청산/수동 주문 등 외부 변경 감지 주기
- 잔존 주문/포지션 변화 재조회 주기

6) 구현 체크
- 서버 시간 동기화 누락 시 서명 오류(-1021) 가능
- 거래소 필터(PRICE_FILTER/MIN_NOTIONAL 등) 적용 누락 가능

7) 주문/계정 모드 관련
- INSUFFICIENT_MARGIN, MIN_NOTIONAL, LOT_SIZE, PRICE_FILTER 등 거래소 주문 거절 코드
- ONE-WAY/HEDGE 모드 불일치 또는 positionSide 누락으로 인한 주문 거절
- 레버리지/격리모드 변경 실패 (open order/권한/제약)
- reduceOnly/closePosition 파라미터 오류

8) 주문/체결 이벤트 불일치
- 주문 상태 업데이트 지연/누락(REST와 WS 불일치)
- 부분체결/평단 갱신 이벤트 누락 → TP/본절 재등록 타이밍 누락 가능

9) 상태 복구/재시작 (비정상 종료 포함)
- 대상: 크래시/강제종료/OS 재부팅 등 예상치 못한 종료 후 재시작
- 복구 원칙:
  - 복구 완료 전 `RECOVERY_LOCK`으로 신규 신호/주문을 금지한다.
  - 거래소 상태(포지션/미체결 주문)를 단일 진실원(source of truth)으로 사용한다.
  - 계정 전체 미체결 주문(진입/청산 구분 없음) 1개라도 있으면 `ENTRY_LOCK`을 유지한다.
- 복구 순서(고정):
  1) `RECOVERY_LOCK=ON`으로 시작하고 텔레그램 신호 처리 루프를 일시 중지한다.
  2) 영속 상태를 복원한다: 채널별 `last_message_id`, 심볼별 `cooldown`, `received_at_local`.
  3) 거래소 스냅샷을 조회한다: 계정 전체 Open Orders, 현재 포지션, 포지션 모드(ONE-WAY/HEDGE).
  4) 전역 잠금을 재계산한다: 포지션>0 또는 Open Orders>0이면 `ENTRY_LOCKED`.
  5) 심볼 상태를 재구성한다: 거래소 기준으로 `ENTRY_ORDER/PHASE`를 동기화하고 불명확 상태는 신규 진입 금지로 처리한다.
  6) 청산 주문 정합성을 맞춘다: 현재 포지션 기준으로 불필요 주문은 취소하고 필요한 청산 주문만 재등록한다.
  7) 비정상 종료 전 모니터링 대기열은 재개하지 않고 초기화한다. (stale 모니터링 방지)
  8) 가격 소스(WS/REST) 정상 여부 확인 후 `RECOVERY_LOCK=OFF`로 전환한다.
  9) 마지막으로 텔레그램 처리 루프를 재개한다. (`message_id <= last_message_id`는 즉시 무시)

10) 강제 청산/ADL
- 강제 청산 또는 ADL로 포지션이 외부에서 종료됨 → 상태 동기화 필요
