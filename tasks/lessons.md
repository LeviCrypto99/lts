# Lessons

- 날짜/시간 조건 요구사항은 경계 포함 여부를 반드시 다시 확인한다. 이번 케이스는 초기 09:00~10:00에서 08:30~10:00(10:01 재개)로 변경되었으므로, 구현 전 최종 경계를 재확정한다.
- 코드 수정 요청을 받으면 구현 전에 `AGENTS.md` 규칙을 먼저 확인하고, 해당 작업 체크리스트를 `tasks/todo.md`에 기록한 뒤 변경을 시작한다.
- 사용자가 설명을 이해하기 어렵다고 하면 용어를 줄이고 원인→동작→결과 순서의 평이한 문장으로 먼저 재설명한다.
- 버그 수정은 항상 최소 영향 범위를 우선 제시하고, 리팩터링/구조개편은 명시 요청이 있을 때만 제안한다.
- 도메인 용어가 모호할 때(예: "박스")는 구현 전에 코드 내 실제 객체(`gapBoxes` vs `lowVolBoxes`)를 먼저 합의하고, 해당 객체 기준으로 요구사항을 고정한 뒤 수정한다.
- 시그널 조건에 "캔들 마감 후 유효"가 포함되면, intrabar 조건이 아니라 `barstate.isconfirmed`와 상태 유효성(`na(fill)` 등)을 함께 걸어 같은 봉 무효화 케이스를 차단한다.
- "N회 제한" 요구(예: 박스당 1회)는 불리언 플래그보다 이벤트 인덱스(`bar_index`) 저장 구조가 재검증/디버깅에 유리하므로 우선 고려한다.
- 시그널 시각화 요구가 타입별로 다르면 단일 `plotshape`를 재활용하지 말고 타입별 bool 시그널을 분리해 색상/위치/모양/크기를 명시적으로 고정한다.
- "현재 활성 객체만 표시" 요구가 있으면 시리즈 플롯(`plot*`)보다 객체(`label/line/box`) 수명 관리(생성/삭제)가 우선이며, 비활성 이벤트(완화/만료)에 삭제 훅을 반드시 둔다.
- "활성"과 "차트에 시각적으로 남아있음"은 다른 조건이다. 삭제 조건을 잡기 전에 기준 이벤트가 `filled`인지 `actual deletion(expired)`인지 사용자 문장으로 다시 고정한다.
- 알림 요구가 단순화되면 로직 변수는 유지해도 `alertcondition`은 즉시 최소화하고, 정규식 검색으로 실제 남은 개수를 확인해 누락/잔존을 차단한다.
- 분할 주문 요구(예: 0.1% 간격 10개)는 구간 양끝 포함 여부에 따라 주문 수가 달라지므로, 구현 전에 "양끝 중 어느 쪽을 제외해 10개를 만들지"를 반드시 확정하고 OCO 상호취소가 분할 잔여 주문을 제거하지 않는지 함께 점검한다.
