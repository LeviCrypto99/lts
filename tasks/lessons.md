# Lessons

- 날짜/시간 조건 요구사항은 경계 포함 여부를 반드시 다시 확인한다. 이번 케이스는 초기 09:00~10:00에서 08:30~10:00(10:01 재개)로 변경되었으므로, 구현 전 최종 경계를 재확정한다.
- 코드 수정 요청을 받으면 구현 전에 `AGENTS.md` 규칙을 먼저 확인하고, 해당 작업 체크리스트를 `tasks/todo.md`에 기록한 뒤 변경을 시작한다.
- 사용자가 설명을 이해하기 어렵다고 하면 용어를 줄이고 원인→동작→결과 순서의 평이한 문장으로 먼저 재설명한다.
- 버그 수정은 항상 최소 영향 범위를 우선 제시하고, 리팩터링/구조개편은 명시 요청이 있을 때만 제안한다.
- 도메인 용어가 모호할 때(예: "박스")는 구현 전에 코드 내 실제 객체(`gapBoxes` vs `lowVolBoxes`)를 먼저 합의하고, 해당 객체 기준으로 요구사항을 고정한 뒤 수정한다.
- 시그널 조건에 "캔들 마감 후 유효"가 포함되면, intrabar 조건이 아니라 `barstate.isconfirmed`와 상태 유효성(`na(fill)` 등)을 함께 걸어 같은 봉 무효화 케이스를 차단한다.
- "N회 제한" 요구(예: 박스당 1회)는 불리언 플래그보다 이벤트 인덱스(`bar_index`) 저장 구조가 재검증/디버깅에 유리하므로 우선 고려한다.
- 시그널 시각화 요구가 타입별로 다르면 단일 `plotshape`를 재활용하지 말고 타입별 bool 시그널을 분리해 색상/위치/모양/크기를 명시적으로 고정한다.
- "현재 활성 객체만 표시" 요구가 있으면 시리즈 플롯(`plot*`)보다 객체(`label/line/box`) 수명 관리(생성/삭제)가 우선이며, 비활성 이벤트(완화/만료)에 삭제 훅을 반드시 둔다.
- "활성"과 "차트에 시각적으로 남아있음"은 다른 조건이다. 삭제 조건을 잡기 전에 기준 이벤트가 `filled`인지 `actual deletion(expired)`인지 사용자 문장으로 다시 고정한다.
- 알림 요구가 단순화되면 로직 변수는 유지해도 `alertcondition`은 즉시 최소화하고, 정규식 검색으로 실제 남은 개수를 확인해 누락/잔존을 차단한다.
- 분할 주문 요구(예: 0.1% 간격 10개)는 구간 양끝 포함 여부에 따라 주문 수가 달라지므로, 구현 전에 "양끝 중 어느 쪽을 제외해 10개를 만들지"를 반드시 확정하고 OCO 상호취소가 분할 잔여 주문을 제거하지 않는지 함께 점검한다.
- 트리거 로직 변경 요청(예: 0.5% 버퍼 제거)이 들어오면 진입 트리거와 주문형 TP 트리거를 분리해 확인하고, 방향별 1틱 선행 규칙(숏 청산 BUY=`target+1tick`, 롱 청산 SELL=`target-1tick`)을 테스트 기대값까지 동시에 갱신해야 회귀가 없다.
- "부분 익절 후 남은 TP 유지" 요구가 있는 전략에서는 `qty change`만으로 exit 전량 취소/재빌드를 걸면 체결 공백이 생길 수 있으므로, 재빌드 조건을 `avg entry changed`로 제한하고 TP fill 이후 누락 보충(replenish)도 명시적으로 차단해야 한다.
- 데이터 조회 실패 시 빈 배열/기본값으로만 처리하면 원인 추적이 막힌다. 특히 진입 타점에 영향 주는 캔들 조회(`klines`)는 실패 사유(HTTP 상태/예외/payload 타입/caller)를 반드시 로그로 남겨야 한다.
- 과호출 완화 요구에서 사용자가 반응속도 저하를 우려하면 루프 주기/핵심 주문 경로는 유지하고, 같은 틱 중복 조회 제거와 RATE_LIMIT 재시도 축소처럼 지연을 유발하지 않는 경로부터 먼저 줄여야 한다.
- 사용자가 "진입도 TP처럼 1틱 선행"을 명시하면 ENTRY 주문의 `price`는 목표가로 유지하고 `stopPrice`만 방향별 1틱 보정해야 하며, 관련 단위/통합 테스트의 `stopPrice` 기대값을 같은 커밋에서 반드시 같이 갱신한다.
- 가격 기준(Last/Mark) 관련 요청이 들어오면 `내부 가격 판정 소스`와 `주문 workingType`을 반드시 같은 기준으로 묶어 변경하고, 시작 로그에 현재 기준(`CONTRACT_PRICE`/`MARK_PRICE`)을 명시해 운영 중 혼선을 줄인다.
- 2차 진입 체결 동기화는 `PARTIALLY_FILLED`를 terminal 상태로 취급하면 안 된다. `PARTIAL -> FILLED` 전이를 추적하지 못하면 PHASE2 보호주문(MDD) 제출이 누락될 수 있으므로, pending 플래그/동기화 루프를 FILLED 확인 시점까지 유지해야 한다.
- 1차/2차가 같은 `entry_mode` 전략이어야 한다면 예산 계산식도 대칭으로 유지해야 한다. 2차 경로에서 `entry_mode` multiplier 누락 시 공격적 모드가 1차에만 반영되어 실사용 시드가 의도보다 크게 줄어든다.
- 사용자가 "됐냐/안됐냐"처럼 이분법 결론을 요구하면 첫 문장을 결론(정상/미완료/조건부)으로 시작하고, 상세 근거는 다음 문단으로 내린다.
- 사용자가 "모니터링도 붙여달라"고 요청하면 단순 로그 1줄이 아니라 `이상 이벤트 상세 로그(스로틀)`와 `주기 요약 로그(카운트/샘플)`를 함께 넣어 운영 추적성을 확보한다.
- 사용자가 최우선 목표를 "빠른 진입"으로 명시하면 트리거 간격 확대(예: 2~3틱 추가) 같은 보수적 대안을 먼저 제안하지 말고, `-2021` 발생 시 주문 타입 전환(예정가 LIMIT)처럼 속도를 유지하는 대안을 우선 제시한다.
- 사용자 제보가 "왜 주문이 안 보이냐"처럼 실행 결과와 어긋나면, "의도대로 동작"을 추정으로 단정하지 말고 `차단 게이트(skip_latch 등)`와 `후보 제거` 코드를 먼저 재확인한 뒤 결론을 말한다.
- 상태머신의 terminal fallback(`IDLE` 리셋, `CANCELED` 확정)은 단일 스냅샷으로 확정하지 말고 `연속 스냅샷 + 최소 경과시간` 확인을 둬서 순간 누락 스냅샷 오판을 차단한다.
- PHASE2 보호주문 변경은 `기존 보호주문 제거 -> 신규 제출` 순서를 피하고, `신규 보호 확인(또는 폴백 확보) -> 기존 제거` 순서로 고정해 무보호 공백을 만들지 않는다.
- 사용자가 "오버수정 금지"를 명시하면 잠재 리스크 전체를 한 번에 건드리지 말고, 재현성/영향도가 높은 이슈만 체크리스트로 고정해 순차 패치한다.
- 거래소 메타 조회 실패(`filter_rules` 누락)는 일시 장애일 수 있으므로 pending 후보를 즉시 삭제하지 말고 유효 심볼만 진행하거나 다음 루프로 재시도하도록 설계한다.
- 사용자가 "새 이슈가 계속 튀어나온다"는 피드백을 주면, 추가 스캔 결과를 즉시 패치 배치(예: 고위험 3건)로 고정하고 그 배치 외 변경은 금지해 반복 발견/수정 사이클을 끊는다.
