# todo

- [x] [RELEASE-2.1.5] `config.py`/`version.json` 버전 문자열 2.1.5 반영
- [x] [RELEASE-2.1.5] launcher/updater 재빌드(`python build.py --target all`)
- [x] [RELEASE-2.1.5] 산출물 SHA256 계산 및 `version.json`의 `app_sha256`/`updater_sha256` 갱신
- [x] [RELEASE-2.1.5] 자동업데이트 메타 최종 점검(파일명, URL, 버전, SHA 일치) + Review 기록

- [x] [HOTFIX-MDD-SECOND] 원인 고정: SECOND_ENTRY `PARTIALLY_FILLED` 이후 재동기화 중단 경로와 MDD 제출 게이트 점검
- [x] [HOTFIX-MDD-SECOND] 코드 수정: PARTIAL 상태에서 `second_entry_order_pending` 유지, FILLED 재동기화 보장
- [x] [HOTFIX-MDD-SECOND] 회귀 점검: SECOND_ENTRY PARTIAL->FILLED 전이에서 `submit_mdd_stop=True` 재확인
- [x] [HOTFIX-MDD-SECOND] Review: 수정 파일/검증결과/잔여리스크 기록

- [x] [AGG-SECOND-SIZING] 2차 진입 예산 계산에 `entry_mode` 반영(AGGRESSIVE=2.0, CONSERVATIVE=1.0)
- [x] [AGG-SECOND-SIZING] 2차 진입 예산/파이프라인 구조화 로그에 `entry_mode`, `mode_multiplier` 추가
- [x] [AGG-SECOND-SIZING] 오케스트레이터에서 2차 파이프라인 호출 시 `selected_entry_mode` 전달
- [x] [AGG-SECOND-SIZING] 단위 테스트 추가: 공격적 모드에서 2차 예산/수량이 보수적 대비 2배 반영 확인
- [x] [AGG-SECOND-SIZING] 검증 실행(py_compile + stage10 엔트리 파이프라인 테스트) 및 Review 기록

- [ ] 멀티 심볼 진입 트리거 주문 설계 확정(First-fill-wins, loser 정리 정책, 동시체결 처리 포함)
- [ ] 모니터링 개념 전환 명세화(가격감시 -> 주문 오케스트레이션 감시) 및 상태/락 설계 문서화
- [x] 진입 트리거 주문 식별자 규칙 도입(`entry` 전용 `clientOrderId` prefix, 예: `LTS-E1-*`/`LTS-E2-*`)
- [x] 오픈오더 분류 로직 보강: `type` 우선이 아니라 `clientOrderId prefix` 우선으로 entry/exit 분리
- [ ] loser 정리 경로 구현: loser 심볼의 `entry` 주문만 취소(기존 TP/BE/MDD 주문은 유지)
- [ ] winner 1차 진입 `FILLED` 이벤트를 단일 기준으로 확정하고 후속 액션 트리거
- [ ] winner 1차 `FILLED` 직후 실행 순서 고정: `loser entry 취소 -> winner TP 10개 트리거 제출 -> winner 2차 진입 트리거 제출`
- [x] winner 1차 `FILLED` 후 TP10/2차진입 주문 즉시 제출 로직 추가(지연 루프 의존 제거)
- [x] 진입 트리거 주문 `stopPrice` 1틱 선행 적용(TP와 동일한 immediate-trigger 회피 정책)
- [x] LP 기준 통일: stop-family 주문 `workingType`을 `CONTRACT_PRICE`로 전환
- [ ] TP10/2차진입 후속 제출 idempotency 보장(중복 이벤트/재연결/재조회에도 1회만 제출)
- [ ] winner/loser 분기에서 2차 진입(E2) 주문까지 포함해 loser 측 entry 주문 전량 정리
- [x] first-fill-wins 경합 락 구현: 첫 체결 심볼 winner 고정 후 타 심볼 신규 진입 차단
- [x] 동시체결 레이스 처리 구현: loser 포지션 즉시 시장가 청산 + 실패/재시도/락 해제 정책 반영
- [ ] 주문 취소 안전성 보강: `entry_order_ref` + `origClientOrderId` 취소 폴백으로 누락 취소 최소화
- [x] 상태 동기화 보강: user stream/REST 스냅샷 기준 winner/loser 판정 일관성 유지
- [ ] 상세 로깅 추가: winner 확정, loser 취소 건수, 동시체결 감지, loser 강제청산 결과, 잔여 주문 수
- [ ] 회귀 테스트 추가: 2종목 동시 모니터링/선착체결/동시체결/TP 유지/entry-only 취소 검증
- [x] 검증 실행: `python3 -m py_compile trade_page.py auto_trade/orchestrator.py auto_trade/entry_pipeline.py`
- [x] 검증 실행: stage15/stage13/stage11/stage7 테스트 세트 재실행 및 결과 기록
- [ ] Review 섹션 작성: 구현 요약/검증 결과/잔여 리스크(동시체결 극단 케이스, 네트워크 지연) 기록

- [ ] 리스크 체크: 단일 런타임 상태(`symbol_state`/`active_symbol`)와 멀티 entry 주문 공존 시 충돌 경로 차단
- [x] 리스크 체크: pre-winner 단계에서 `has_any_open_order -> entry_locked`로 신규 신호 차단되는 경로 완화
- [x] 리스크 체크: `clientAlgoId`까지 포함한 주문 식별 정규화(알고 주문 분류 누락 방지)
- [x] 리스크 체크: STOP/TAKE_PROFIT 타입 기반 오분류 제거(ENTRY trigger가 EXIT로 분류되지 않게 보정)
- [ ] 리스크 체크: 재시작/재연결 후 TP10/E2 중복 제출 방지 상태 복구(idempotency + startup reconcile)
- [ ] 리스크 체크: risk 신호와 fill 이벤트 동시 도착 시 순서경합 처리(winner 고정 원자성 보장)
- [ ] 리스크 체크: loser 취소 실패/이미체결 시 강제청산 폴백과 재시도 상한 적용
- [ ] 리스크 체크: 트리거 즉시발동 거부(-2021) 방지용 stopPrice/workingType 검증
- [ ] 리스크 체크: 대량 주문 제출 구간(rate-limit)에서 보호주문 우선순위(TP 일부 실패 시 BE/MDD 우선) 적용
- [x] 리스크 체크: user stream/open-order 정규화에 `clientOrderId`/`origClientOrderId`/`clientAlgoId` 보존(ENTRY prefix 분류 누락 방지)
- [x] 리스크 체크: `active_symbol` 스냅샷 복구 시 다심볼 open-order/position에서 winner 비결정 선택 방지(체결시각 기준 고정)
- [ ] 리스크 체크: `entry_order_ref_by_symbol` 단일 orderId 캐시를 다중 entry 주문 추적 구조로 확장(E1/E2/loser 동시 존재 대응)
- [ ] 리스크 체크: recovery snapshot의 `has_any_open_order -> ENTRY_ORDER` 단순 매핑으로 인한 다심볼 오판 방지(심볼별 복구 로직 추가)
- [ ] 리스크 체크: loser `PARTIALLY_FILLED` 시나리오 처리(잔량 entry 취소 + 체결분 시장가 청산 + 수량 재검증)
- [ ] 리스크 체크: 동시 트리거 마진부족/주문거부 시 정책 명시(재큐잉 금지 여부, winner 재선정/skip 기준, 로그 코드)
- [ ] 리스크 체크: user stream 공백(listenKey 재연결/지연) 구간 fill 누락 시 REST 강제 reconcile로 winner/loser 판정 복구

- [x] [HOTFIX-LAST-PRICE-ENFORCE] stop-family open-order `workingType` 검증 및 `MARK_PRICE` 잔존 주문 자동 취소/재생성 경로 반영
- [x] [HOTFIX-LAST-PRICE-ENFORCE] user stream/open-order 정규화에 `workingType` 보존 및 점검 로그 추가
- [x] [HOTFIX-LAST-PRICE-ENFORCE] 트리거 사이클 가격 누락 심볼에 REST last-price 보강 조회 추가(진입 트리거 타입 결정 보강)
- [x] [HOTFIX-LAST-PRICE-ENFORCE] 검증 실행(unittest + py_compile) 및 요청사항 1/2/3 점검 결과 Review 기록
- [x] [HOTFIX-LAST-PRICE-ENFORCE] 운영 모니터링 보강: workingType 이상 이벤트 상세/주기 요약 로그 추가

## Review
- HOTFIX-MDD-SECOND 수정 파일: `auto_trade/orchestrator.py`
- 핵심 변경: `sync_entry_fill_flow()`에서 `SECOND_ENTRY/PARTIALLY_FILLED`를 terminal로 보지 않고 `second_entry_order_pending=True` 유지
- 기대 효과: PARTIAL 이후 다음 루프에서 FILLED 재동기화가 수행되어 `SECOND_ENTRY_FILLED_PHASE2_CONFIRM` 경로 및 MDD 제출 트리거가 복구됨
- 검증: `python3 -m py_compile auto_trade/orchestrator.py trade_page.py auto_trade/execution_flow.py auto_trade/entry_pipeline.py` 통과
- 추가 검증: 단위 시나리오 스크립트로 `PARTIAL -> FILLED` 전이 시 `pending=True -> False`, `submit_mdd_stop=False -> True` 확인
- 잔여 리스크: 이미 손상된 런타임 상태(재시작 직후 `second_entry_order_pending=False`)에서 과거 PARTIAL 이력을 잃은 세션은 별도 복구 로직이 필요할 수 있음
- AGG-SECOND-SIZING 수정 파일: `auto_trade/entry_pipeline.py`, `auto_trade/orchestrator.py`, `tests/test_stage10_entry_pipeline.py`
- 핵심 변경: 2차 진입 예산 계산을 `available_usdt * (1 - margin_buffer_pct) * mode_multiplier`로 변경하고, 오케스트레이터가 2차 파이프라인에 `selected_entry_mode`를 전달하도록 연결
- 로깅 변경: 2차 예산/파이프라인 로그에 `entry_mode`, `mode_multiplier` 필드 추가
- 검증: `python3 -m py_compile auto_trade/entry_pipeline.py auto_trade/orchestrator.py tests/test_stage10_entry_pipeline.py` 통과
- 테스트: `python3 -m unittest tests/test_stage10_entry_pipeline.py` 통과(14 tests)
- 추가 테스트: `python3 -m unittest tests/test_stage13_orchestrator_integration.py` 통과(29 tests)
- 잔여 리스크: 공격적 모드에서 2차 주문 수량이 커져 체결 시점 가용증거금/수수료 여유가 부족하면 `INSUFFICIENT_MARGIN` 빈도가 증가할 수 있으며, 현재는 기존 margin-refresh 재시도 경로로 완화됨
- HOTFIX-LAST-PRICE-ENFORCE 수정 파일: `trade_page.py`
- 핵심 변경: PHASE 정책 루프에서 stop-family open-order의 `workingType`을 검사해 `MARK_PRICE` 잔존 주문을 자동 취소 대상으로 분류하고, 다음 루프에서 `CONTRACT_PRICE` 기준 주문으로 재생성되도록 보강
- 보강 변경: user stream/open-order 정규화 경로에 `workingType` 필드 보존 로직 추가(`wt`/`workingType` -> `workingType`)
- 트리거 보강: 진입 트리거 사이클에서 가격 누락 심볼은 REST last-price 보강 조회 후 제출 판단하도록 변경
- 모니터링 보강: `workingType` 이상(누락/비CONTRACT) 이벤트를 user stream/open-order 병합/phase 스캔에서 계수하고, throttled 상세 로그 + 60초 요약 로그를 추가
- 검증: `python3 -m py_compile trade_page.py auto_trade/order_gateway.py auto_trade/entry_pipeline.py auto_trade/orchestrator.py tests/test_stage9_order_gateway.py tests/test_stage10_entry_pipeline.py tests/test_stage11_execution_flow.py tests/test_stage13_orchestrator_integration.py` 통과
- 테스트: `python3 -m unittest tests.test_stage9_order_gateway tests.test_stage10_entry_pipeline tests.test_stage11_execution_flow tests.test_stage13_orchestrator_integration` 통과(83 tests)
- 요청사항 점검:
- 1) 주문 가격 기준: 신규 stop-family 주문은 `CONTRACT_PRICE`로 생성되고, 기존 `MARK_PRICE` stop-family 주문은 정책 루프에서 교체되도록 반영
- 2) 진입 트리거 주문: entry는 trigger order(STOP/TAKE_PROFIT) 경로를 유지하며, mark price 누락 시 REST fallback으로 타입 결정 입력값(`reference_mark_price`) 보강
- 3) tasks/todo 반영: 본 HOTFIX 항목 4건 추가 후 완료 체크 및 Review 기록 반영 완료
- 잔여 리스크: 거래소 응답에서 `workingType`이 비어 오는 비정형 payload는 강제교체 대상에서 제외되므로, 운영 로그에서 해당 케이스 존재 여부를 1회 모니터링 필요
- RELEASE-2.1.5 수정 파일: `config.py`, `version.json`, `tasks/todo.md`
- 빌드: `.venv/Scripts/python.exe build.py --target all` 실행 완료(`dist/LTS V2.1.5.exe`, `dist/LTS-Updater.exe`)
- 배포 파일 반영: `dist` 산출물을 루트 `LTS V2.1.5.exe`, `LTS-Updater.exe`로 복사
- SHA256:
- `LTS V2.1.5.exe` = `d5533cecdb85394f23a2fe8e46a3377ea0086d75d5132238f84d78dc2f7f360c`
- `LTS-Updater.exe` = `32cae164cd0a223340b173bc171e1a7d05c58b87b94e43e4e4faa3b6a305399f`
- 자동업데이트 메타 점검: `min_version=2.1.5`, `app_url=LTS%20V2.1.5.exe`, `app_sha256/updater_sha256` 모두 신규 산출물과 일치
