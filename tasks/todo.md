# todo

- [x] [HOTFIX-TRADE-3HIGHRISK-20260301] 플랜 고정: 활성심볼 stale/trigger deferred starvation/loser entry 취소실패 잔류주문 3건만 최소 수정
- [x] [HOTFIX-TRADE-3HIGHRISK-20260301] 수정 1: active_symbol stale 반환 차단(포지션/오더 미일치 시 스냅샷 심볼 재선정)
- [x] [HOTFIX-TRADE-3HIGHRISK-20260301] 수정 2: deferred 심볼이 같은 사이클의 다른 pending 후보 처리를 막지 않도록 skip 가드
- [x] [HOTFIX-TRADE-3HIGHRISK-20260301] 수정 3: winner 정책 loser entry 취소 실패 심볼 재시도 큐 도입(잔류 주문 자동 정리)
- [x] [HOTFIX-TRADE-3HIGHRISK-20260301] 검증: stage10/stage11/stage13/stage15 + py_compile
- [x] [HOTFIX-TRADE-3HIGHRISK-20260301] Review: 변경 파일/근거/검증/잔여 리스크 기록

- [x] [AUDIT-TRADE-DEFECT-SWEEP-20260301-2] 플랜 고정: 거래 영역 코드 결함 전수 스캔(과수정 금지, 고위험만 식별)
- [x] [AUDIT-TRADE-DEFECT-SWEEP-20260301-2] 점검 1: 주문 제출/취소 idempotency 및 누락 가능 분기 확인
- [x] [AUDIT-TRADE-DEFECT-SWEEP-20260301-2] 점검 2: 상태 전이(ENTRY/PHASE/IDLE)에서 조기리셋/오판 경로 확인
- [x] [AUDIT-TRADE-DEFECT-SWEEP-20260301-2] 점검 3: 보호주문(MDD/BE/TP) 공백 또는 중복 제출 가능 분기 확인
- [x] [AUDIT-TRADE-DEFECT-SWEEP-20260301-2] Review: 심각 이슈만 근거 라인으로 정리(필요시 최소 수정안 제시)

- [x] [HARDEN-NONCONSUME-RETRY-20260301] 플랜 고정: 주문기회 유실(후보 소거) 리스크만 최소 수정하고 상태머신/전략 의도 유지
- [x] [HARDEN-NONCONSUME-RETRY-20260301] 수정 1: pre-order setup 실패 중 재시도 가능 사유는 후보를 소거하지 않고 deferred 처리
- [x] [HARDEN-NONCONSUME-RETRY-20260301] 수정 2: pipeline 실패 중 `_KEEP_STATE` 사유는 후보를 보존하고 deferred reason으로 표기
- [x] [HARDEN-NONCONSUME-RETRY-20260301] 수정 3: deferred 후보는 같은 trigger loop에서 반복 소모되지 않도록 loop break 가드 추가
- [x] [HARDEN-NONCONSUME-RETRY-20260301] 수정 4: 1차 상태추론 fallback에 snapshot 건강성 체크 추가(조기 CANCELED 억제)
- [x] [HARDEN-NONCONSUME-RETRY-20260301] 검증: py_compile + stage10/stage11/stage13/stage15
- [x] [HARDEN-NONCONSUME-RETRY-20260301] Review: 변경 파일/근거/검증/잔여 리스크 기록

- [x] [AUDIT-MINIMAL-HIGHRISK-20260301] 플랜 고정: trade/orchestrator/entry/exit 경로 전수 스캔 후 고위험만 최소 수정(리팩터링 금지)
- [x] [AUDIT-MINIMAL-HIGHRISK-20260301] 점검 1: 단일 실패가 전체 상태/후보를 초기화하는 분기 전수 확인
- [x] [AUDIT-MINIMAL-HIGHRISK-20260301] 점검 2: 취소 범위가 과도해 보호주문까지 제거되는 경로 전수 확인
- [x] [AUDIT-MINIMAL-HIGHRISK-20260301] 점검 3: 상태추론 fallback 오판 가능성과 복구 약한 분기 전수 확인
- [x] [AUDIT-MINIMAL-HIGHRISK-20260301] 수정: 증거 기반 고위험 항목만 최소 분기 패치 + 로깅 보강
- [x] [AUDIT-MINIMAL-HIGHRISK-20260301] 검증: py_compile + stage10/stage11/stage13/stage15
- [x] [AUDIT-MINIMAL-HIGHRISK-20260301] Review: 변경 파일/근거/검증/잔여 리스크 기록

- [x] [HARDEN-MINIMAL-5RISK-20260301] 플랜 고정: 지적된 1~5번 이슈만 수정하고 상태머신/전략 의도는 유지(리팩터링 금지)
- [x] [HARDEN-MINIMAL-5RISK-20260301] 수정 1: pre-order setup 실패가 전체 pending 초기화로 확산되지 않도록 실패 심볼 범위로 제한
- [x] [HARDEN-MINIMAL-5RISK-20260301] 수정 2: setup 재시도 open-order 정리 시 보호주문 취소 금지(entry 주문만 취소)
- [x] [HARDEN-MINIMAL-5RISK-20260301] 수정 3: 필터룰 누락 심볼이 있어도 유효 심볼 트리거 사이클은 계속 진행
- [x] [HARDEN-MINIMAL-5RISK-20260301] 수정 4: 2차 상태 추론 cached order ref는 2차 clientOrderId 검증 후만 사용
- [x] [HARDEN-MINIMAL-5RISK-20260301] 수정 5: 외부 리셋 시 split TP submit guard 초기화
- [x] [HARDEN-MINIMAL-5RISK-20260301] 검증: py_compile + stage10/stage11/stage13/stage15 회귀
- [x] [HARDEN-MINIMAL-5RISK-20260301] Review: 변경 파일/검증 결과/잔여 리스크 기록

- [x] [HARDEN-PHASE-GUARD-20260301] 플랜 확정: ENTRY_ORDER->IDLE 조기리셋/PHASE2 보호주문 공백/2차 상태추론 오판의 안전 전이 규칙 정의
- [x] [HARDEN-PHASE-GUARD-20260301] 코드 수정 1: no_position_no_orders 리셋을 연속확인+시간확인+스냅샷건강성 기준으로 지연 확정
- [x] [HARDEN-PHASE-GUARD-20260301] 코드 수정 2: PHASE2에서 보호주문 공백 금지(2차 미완체결 구간 본절 STOP 유지, 완체결 MDD 전환 시 안전 폴백)
- [x] [HARDEN-PHASE-GUARD-20260301] 코드 수정 3: 2차 상태 fallback을 즉시 CANCELED 확정하지 않고 연속확인 후 확정
- [x] [HARDEN-PHASE-GUARD-20260301] 검증: stage11/stage13/stage15 회귀 + py_compile
- [x] [HARDEN-PHASE-GUARD-20260301] Review: 변경 파일/검증결과/잔여리스크 기록

- [x] [HOTFIX-MDD-EFFECTIVE-20] 요구사항 확정: UI 표시 MDD(15%) 유지 + 실제 MDD 스탑 계산 비율 20% 적용 범위 식별
- [x] [HOTFIX-MDD-EFFECTIVE-20] 코드 수정: MDD 스탑 타겟 계산/제출 경로에 유효 비율(20%) 공통 적용 + 로깅 추가
- [x] [HOTFIX-MDD-EFFECTIVE-20] 검증: 관련 회귀 테스트(mdd stop 경로) 및 py_compile 실행
- [x] [HOTFIX-MDD-EFFECTIVE-20] Review: 변경 파일/검증 결과/잔여 리스크 기록

- [x] [RELEASE-2.1.6] `config.py`/`version.json` 버전 문자열 2.1.6 반영
- [x] [RELEASE-2.1.6] launcher/updater 재빌드(`python build.py --target all`)
- [x] [RELEASE-2.1.6] 산출물 SHA256 계산 및 `version.json`의 `app_sha256`/`updater_sha256` 갱신
- [x] [RELEASE-2.1.6] 자동업데이트 메타 최종 점검(파일명, URL, 버전, SHA 일치) + Review 기록

- [x] [RELEASE-2.1.7] `config.py`/`version.json` 버전 문자열 2.1.7 반영
- [x] [RELEASE-2.1.7] launcher/updater 재빌드(`python build.py --target all`)
- [x] [RELEASE-2.1.7] 산출물 SHA256 계산 및 `version.json`의 `app_sha256`/`updater_sha256` 갱신
- [x] [RELEASE-2.1.7] 자동업데이트 메타 최종 점검(파일명, URL, 버전, SHA 일치) + Review 기록

- [x] [RELEASE-2.1.5] `config.py`/`version.json` 버전 문자열 2.1.5 반영
- [x] [RELEASE-2.1.5] launcher/updater 재빌드(`python build.py --target all`)
- [x] [RELEASE-2.1.5] 산출물 SHA256 계산 및 `version.json`의 `app_sha256`/`updater_sha256` 갱신
- [x] [RELEASE-2.1.5] 자동업데이트 메타 최종 점검(파일명, URL, 버전, SHA 일치) + Review 기록

- [x] [HOTFIX-MDD-SECOND] 원인 고정: SECOND_ENTRY `PARTIALLY_FILLED` 이후 재동기화 중단 경로와 MDD 제출 게이트 점검
- [x] [HOTFIX-MDD-SECOND] 코드 수정: PARTIAL 상태에서 `second_entry_order_pending` 유지, FILLED 재동기화 보장
- [x] [HOTFIX-MDD-SECOND] 회귀 점검: SECOND_ENTRY PARTIAL->FILLED 전이에서 `submit_mdd_stop=True` 재확인
- [x] [HOTFIX-MDD-SECOND] Review: 수정 파일/검증결과/잔여리스크 기록

- [x] [AGG-SECOND-SIZING] 2차 진입 예산 계산에 `entry_mode` 반영(AGGRESSIVE=2.0, CONSERVATIVE=1.0)
- [x] [AGG-SECOND-SIZING] 2차 진입 예산/파이프라인 구조화 로그에 `entry_mode`, `mode_multiplier` 추가
- [x] [AGG-SECOND-SIZING] 오케스트레이터에서 2차 파이프라인 호출 시 `selected_entry_mode` 전달
- [x] [AGG-SECOND-SIZING] 단위 테스트 추가: 공격적 모드에서 2차 예산/수량이 보수적 대비 2배 반영 확인
- [x] [AGG-SECOND-SIZING] 검증 실행(py_compile + stage10 엔트리 파이프라인 테스트) 및 Review 기록

- [ ] 멀티 심볼 진입 트리거 주문 설계 확정(First-fill-wins, loser 정리 정책, 동시체결 처리 포함)
- [ ] 모니터링 개념 전환 명세화(가격감시 -> 주문 오케스트레이션 감시) 및 상태/락 설계 문서화
- [x] 진입 트리거 주문 식별자 규칙 도입(`entry` 전용 `clientOrderId` prefix, 예: `LTS-E1-*`/`LTS-E2-*`)
- [x] 오픈오더 분류 로직 보강: `type` 우선이 아니라 `clientOrderId prefix` 우선으로 entry/exit 분리
- [ ] loser 정리 경로 구현: loser 심볼의 `entry` 주문만 취소(기존 TP/BE/MDD 주문은 유지)
- [ ] winner 1차 진입 `FILLED` 이벤트를 단일 기준으로 확정하고 후속 액션 트리거
- [ ] winner 1차 `FILLED` 직후 실행 순서 고정: `loser entry 취소 -> winner TP 10개 트리거 제출 -> winner 2차 진입 트리거 제출`
- [x] winner 1차 `FILLED` 후 TP10/2차진입 주문 즉시 제출 로직 추가(지연 루프 의존 제거)
- [x] 진입 트리거 주문 `stopPrice` 1틱 선행 적용(TP와 동일한 immediate-trigger 회피 정책)
- [x] LP 기준 통일: stop-family 주문 `workingType`을 `CONTRACT_PRICE`로 전환
- [ ] TP10/2차진입 후속 제출 idempotency 보장(중복 이벤트/재연결/재조회에도 1회만 제출)
- [ ] winner/loser 분기에서 2차 진입(E2) 주문까지 포함해 loser 측 entry 주문 전량 정리
- [x] first-fill-wins 경합 락 구현: 첫 체결 심볼 winner 고정 후 타 심볼 신규 진입 차단
- [x] 동시체결 레이스 처리 구현: loser 포지션 즉시 시장가 청산 + 실패/재시도/락 해제 정책 반영
- [ ] 주문 취소 안전성 보강: `entry_order_ref` + `origClientOrderId` 취소 폴백으로 누락 취소 최소화
- [x] 상태 동기화 보강: user stream/REST 스냅샷 기준 winner/loser 판정 일관성 유지
- [ ] 상세 로깅 추가: winner 확정, loser 취소 건수, 동시체결 감지, loser 강제청산 결과, 잔여 주문 수
- [ ] 회귀 테스트 추가: 2종목 동시 모니터링/선착체결/동시체결/TP 유지/entry-only 취소 검증
- [x] 검증 실행: `python3 -m py_compile trade_page.py auto_trade/orchestrator.py auto_trade/entry_pipeline.py`
- [x] 검증 실행: stage15/stage13/stage11/stage7 테스트 세트 재실행 및 결과 기록
- [ ] Review 섹션 작성: 구현 요약/검증 결과/잔여 리스크(동시체결 극단 케이스, 네트워크 지연) 기록

- [ ] 리스크 체크: 단일 런타임 상태(`symbol_state`/`active_symbol`)와 멀티 entry 주문 공존 시 충돌 경로 차단
- [x] 리스크 체크: pre-winner 단계에서 `has_any_open_order -> entry_locked`로 신규 신호 차단되는 경로 완화
- [x] 리스크 체크: `clientAlgoId`까지 포함한 주문 식별 정규화(알고 주문 분류 누락 방지)
- [x] 리스크 체크: STOP/TAKE_PROFIT 타입 기반 오분류 제거(ENTRY trigger가 EXIT로 분류되지 않게 보정)
- [ ] 리스크 체크: 재시작/재연결 후 TP10/E2 중복 제출 방지 상태 복구(idempotency + startup reconcile)
- [ ] 리스크 체크: risk 신호와 fill 이벤트 동시 도착 시 순서경합 처리(winner 고정 원자성 보장)
- [ ] 리스크 체크: loser 취소 실패/이미체결 시 강제청산 폴백과 재시도 상한 적용
- [ ] 리스크 체크: 트리거 즉시발동 거부(-2021) 방지용 stopPrice/workingType 검증
- [ ] 리스크 체크: 대량 주문 제출 구간(rate-limit)에서 보호주문 우선순위(TP 일부 실패 시 BE/MDD 우선) 적용
- [x] 리스크 체크: user stream/open-order 정규화에 `clientOrderId`/`origClientOrderId`/`clientAlgoId` 보존(ENTRY prefix 분류 누락 방지)
- [x] 리스크 체크: `active_symbol` 스냅샷 복구 시 다심볼 open-order/position에서 winner 비결정 선택 방지(체결시각 기준 고정)
- [ ] 리스크 체크: `entry_order_ref_by_symbol` 단일 orderId 캐시를 다중 entry 주문 추적 구조로 확장(E1/E2/loser 동시 존재 대응)
- [ ] 리스크 체크: recovery snapshot의 `has_any_open_order -> ENTRY_ORDER` 단순 매핑으로 인한 다심볼 오판 방지(심볼별 복구 로직 추가)
- [ ] 리스크 체크: loser `PARTIALLY_FILLED` 시나리오 처리(잔량 entry 취소 + 체결분 시장가 청산 + 수량 재검증)
- [ ] 리스크 체크: 동시 트리거 마진부족/주문거부 시 정책 명시(재큐잉 금지 여부, winner 재선정/skip 기준, 로그 코드)
- [ ] 리스크 체크: user stream 공백(listenKey 재연결/지연) 구간 fill 누락 시 REST 강제 reconcile로 winner/loser 판정 복구

- [x] [HOTFIX-LAST-PRICE-ENFORCE] stop-family open-order `workingType` 검증 및 `MARK_PRICE` 잔존 주문 자동 취소/재생성 경로 반영
- [x] [HOTFIX-LAST-PRICE-ENFORCE] user stream/open-order 정규화에 `workingType` 보존 및 점검 로그 추가
- [x] [HOTFIX-LAST-PRICE-ENFORCE] 트리거 사이클 가격 누락 심볼에 REST last-price 보강 조회 추가(진입 트리거 타입 결정 보강)
- [x] [HOTFIX-LAST-PRICE-ENFORCE] 검증 실행(unittest + py_compile) 및 요청사항 1/2/3 점검 결과 Review 기록
- [x] [HOTFIX-LAST-PRICE-ENFORCE] 운영 모니터링 보강: workingType 이상 이벤트 상세/주기 요약 로그 추가

- [x] [HOTFIX-ENTRY-2021-LIMIT-FALLBACK] `-2021` 발생 경로 확정 및 ENTRY 파이프라인 폴백 설계 반영(기존 stop-family 유지, 실패 시 limit 재주문)
- [x] [HOTFIX-ENTRY-2021-LIMIT-FALLBACK] 1차/2차 ENTRY 공통 `-2021` 감지 시 `LIMIT SELL @ 진입예정가` 1회 폴백 구현 + 로깅 추가
- [x] [HOTFIX-ENTRY-2021-LIMIT-FALLBACK] 회귀 테스트 추가(`-2021` 후 limit 재주문 성공/실패) 및 검증 실행
- [x] [HOTFIX-ENTRY-2021-LIMIT-FALLBACK] Review 기록(수정 파일/검증 결과/잔여 리스크)

- [x] [HOTFIX-SECOND-ENTRY-RETRY] 1차 FILLED 이후 2차 진입 미제출 코드 경로 점검(`skip_latch`/후보 제거/게이트 분기)
- [x] [HOTFIX-SECOND-ENTRY-RETRY] 2차 진입 실패 후 재등록 차단 제거(`skip_latch` 비차단화) + 재시도 로깅 추가
- [x] [HOTFIX-SECOND-ENTRY-RETRY] 검증 실행(`py_compile` + orchestrator 관련 테스트) 및 Review 기록

## Review
- HOTFIX-TRADE-3HIGHRISK-20260301 수정 파일: `trade_page.py`, `tests/test_stage15_trade_page_regression.py`, `tasks/todo.md`
- 수정 1(active symbol stale): 포지션 없음 + active_symbol 미일치 + open_orders 존재 시 stale active를 그대로 반환하지 않고 open-order 심볼을 우선 반환하도록 보정(`trade_page.py`)
- 수정 2(deferred starvation): trigger cycle 내에서 deferred 심볼은 임시 제외하고 다른 pending 후보를 계속 처리한 뒤, deferred 후보를 병합 복원하도록 보강(`trade_page.py`)
- 수정 3(loser 취소 실패 잔류): winner 정책에서 loser entry 취소 실패 심볼을 retry set에 적재하고, fill-sync pass마다 entry 취소 재시도 루프를 수행해 잔류 주문 자동 정리(`trade_page.py`)
- 상태정리 보강: leading/reset/position-zero/risk-reset/external-clear 경로에 retry set 정리 추가
- 테스트 추가:
- `test_resolve_active_symbol_snapshot_ignores_stale_active_when_open_orders_exist`
- `test_trigger_cycle_deferred_symbol_allows_other_candidate_in_same_cycle`
- `test_winner_policy_failed_loser_entry_cancel_registers_retry_symbol`
- 검증: `python3 -m py_compile trade_page.py tests/test_stage15_trade_page_regression.py auto_trade/orchestrator.py auto_trade/execution_flow.py auto_trade/entry_pipeline.py` 통과
- 회귀 테스트: `python3 -m unittest tests/test_stage10_entry_pipeline.py tests/test_stage11_execution_flow.py tests/test_stage13_orchestrator_integration.py tests/test_stage15_trade_page_regression.py` 통과(108 tests)
- 잔여 리스크: loser entry 취소가 장시간 실패(지속 네트워크/권한 오류)하면 retry 로그가 증가할 수 있으나, 기존처럼 침묵 잔류되는 대신 명시 재시도로 전환됨
- AUDIT-TRADE-DEFECT-SWEEP-20260301-2 점검 범위: `trade_page.py`, `auto_trade/orchestrator.py`, `auto_trade/execution_flow.py` (거래 경로 결함만 재감사)
- High(해결됨: HOTFIX-TRADE-3HIGHRISK-20260301): active symbol stale 반환 보정 완료.
- High(해결됨: HOTFIX-TRADE-3HIGHRISK-20260301): deferred 후보 starvation 완화(같은 사이클 타 후보 처리) 완료.
- High(해결됨: HOTFIX-TRADE-3HIGHRISK-20260301): winner 정책 loser entry 취소 실패 재시도 큐 추가 완료.
- 잔여 리스크 판단: 위 3건은 모두 "의도와 다른 주문 생존/처리 지연"으로 실거래 영향도가 높아 최소 범위 보강 패치 우선순위가 높음.
- HARDEN-NONCONSUME-RETRY-20260301 수정 파일: `auto_trade/orchestrator.py`, `trade_page.py`, `tests/test_stage13_orchestrator_integration.py`, `tasks/todo.md`
- 수정 1: pre-order setup 실패 중 `POSITION_MODE_UNKNOWN/SYMBOL_SETUP_*/LEVERAGE_SET_FAILED_*/MARGIN_TYPE_SET_FAILED_*` 사유는 후보를 소거하지 않고 `PRE_ORDER_SETUP_DEFERRED_*`로 보류
- 수정 2: entry pipeline 실패 중 reason이 `_KEEP_STATE`이면 후보를 소거하지 않고 `TRIGGER_PIPELINE_DEFERRED_*`로 보류
- 수정 3: deferred 결과는 같은 signal loop에서 반복 소모되지 않게 `trade_page` trigger loop에 즉시 break 가드 추가
- 수정 4: 1차 fill sync fallback(`ENTRY_ORDER`)의 terminal `CANCELED` 확정 전에 account snapshot 건강성 체크를 추가해 조기 취소 인식 억제
- 테스트 갱신: stage13 pre-order non-reset 실패 케이스를 `후보 보존 + deferred reason` 기대값으로 변경
- 검증: `python3 -m py_compile auto_trade/orchestrator.py trade_page.py tests/test_stage13_orchestrator_integration.py tests/test_stage15_trade_page_regression.py` 통과
- 회귀 테스트: `python3 -m unittest tests/test_stage10_entry_pipeline.py`(17), `tests/test_stage11_execution_flow.py`(23), `tests/test_stage13_orchestrator_integration.py`(29), `tests/test_stage15_trade_page_regression.py`(36) 모두 통과
- 잔여 리스크: deferred 사유가 장시간 지속되면 동일 후보가 다음 루프마다 재시도되므로 로그 빈도는 증가할 수 있음(주문기회 유실 방지 우선의 의도된 트레이드오프)
- AUDIT-MINIMAL-HIGHRISK-20260301 수정 파일: `trade_page.py`, `tasks/todo.md`
- 수정 A: trigger cycle에서 `missing_filter_rules` 발생 시 pending 후보를 삭제하지 않고 유효 심볼만 계속 처리하도록 변경(일시적 exchange-info 누락으로 후보 유실 방지)
- 수정 B: IDLE 리셋/winner 정리/risk reset 경로에서 `_tp_trigger_submit_guard_by_symbol`를 심볼 단위로 정리하도록 보강(다음 진입 TP 제출 guard 오차단 방지)
- 수정 C: exit removed-order 조회가 일시 실패해 `FILLED` 확인이 불확실할 때, 이전 exit snapshot을 1회 이상 유지해 다음 루프에서 OCO fill 판별을 재시도하도록 보강
- 로그 보강: `Trigger cycle continues with valid filter symbols only`, `OCO fill detection deferred for retry` 등 복구 경로 로그 추가
- 검증: `python3 -m py_compile trade_page.py auto_trade/orchestrator.py auto_trade/execution_flow.py auto_trade/entry_pipeline.py tests/test_stage10_entry_pipeline.py tests/test_stage11_execution_flow.py tests/test_stage13_orchestrator_integration.py tests/test_stage15_trade_page_regression.py` 통과
- 테스트: `python3 -m unittest tests/test_stage10_entry_pipeline.py`(17), `tests/test_stage11_execution_flow.py`(23), `tests/test_stage13_orchestrator_integration.py`(29), `tests/test_stage15_trade_page_regression.py`(36) 모두 통과
- 잔여 리스크: 거래소 query 응답이 장시간 비정상인 경우 OCO fill 판별 재시도가 지속되어 로그가 증가할 수 있음(무방비보다 재시도 우선으로 의도된 트레이드오프)
- HARDEN-MINIMAL-5RISK-20260301 수정 파일: `trade_page.py`, `tasks/todo.md`
- 수정 1: pre-order setup 실패 시 `setup_reset=True`로 전체 pending 초기화하던 경로를 `False`로 변경해 실패 심볼 범위 처리로 제한
- 수정 2: pre-order setup 재시도의 open-order 정리를 `cancel_all`이 아닌 `entry 주문 취소`로 제한해 TP/본절/MDD 보호주문 취소를 방지
- 수정 3: 트리거 사이클에서 filter rule 누락 심볼만 pending에서 제거하고, 유효 심볼은 같은 사이클에서 계속 처리
- 수정 4: 2차 상태 추론의 cached order ref 사용 시 `clientOrderId` 2차 prefix 검증을 추가해 1차 주문 참조 오판 차단
- 수정 5: 외부 리셋 시 `_tp_trigger_submit_guard_by_symbol` 초기화 추가
- 검증: `python3 -m py_compile trade_page.py auto_trade/orchestrator.py auto_trade/entry_pipeline.py tests/test_stage10_entry_pipeline.py tests/test_stage11_execution_flow.py tests/test_stage13_orchestrator_integration.py tests/test_stage15_trade_page_regression.py` 통과
- 테스트: `python3 -m unittest tests/test_stage10_entry_pipeline.py`(17), `tests/test_stage11_execution_flow.py`(23), `tests/test_stage13_orchestrator_integration.py`(29), `tests/test_stage15_trade_page_regression.py`(36) 모두 통과
- 잔여 리스크: filter rule 누락 심볼은 pending에서 제거되므로, 거래소 메타 지연/오타 심볼 신호는 자동 재시도 대신 신규 신호 재유입이 필요함
- HARDEN-PHASE-GUARD-20260301 수정 파일: `trade_page.py`, `tasks/todo.md`
- 핵심 변경 1: `ENTRY_ORDER/PHASE* -> IDLE` fallback reset을 `연속 3회 + 8초` 확인 충족 시점에만 확정하고, 가드/스냅샷 미충족 시 확인 카운터를 즉시 초기화
- 핵심 변경 2: PHASE2에서 `split TP guard`로 split 제출을 스킵해도 보호주문 정책은 계속 진행되도록 변경, `2차 미완체결 구간`은 본절 STOP 유지/보강, `2차 완체결 구간`은 MDD 실패 시 본절 STOP 폴백으로 무방비 구간 차단
- 핵심 변경 3: 2차 상태 fallback을 즉시 `CANCELED` 확정하지 않고 `연속 3회 + 8초` 확인 후 확정하도록 보수화(조회 성공/실체결 증거 시 확인 카운터 즉시 해제)
- 안정성 보강: 외부 리셋/포지션제로 리셋/승자정책 정리 경로에 confirmation tracker 클리어 추가, 자격증명 미초기화 환경에서 `_fetch_position_mode`/`_fetch_multi_assets_margin_mode`가 `AttributeError` 없이 안전하게 `UNKNOWN`/`api_credentials_missing` 반환
- 검증: `python3 -m py_compile trade_page.py tests/test_stage15_trade_page_regression.py` 통과
- 테스트: `python3 -m unittest tests/test_stage11_execution_flow.py` 통과(23 tests), `python3 -m unittest tests/test_stage13_orchestrator_integration.py` 통과(29 tests), `python3 -m unittest tests/test_stage15_trade_page_regression.py` 통과(36 tests)
- 잔여 리스크: 보수적 확정 정책으로 인해 실제 주문/포지션이 사라진 뒤 IDLE 복귀와 2차 CANCELED 확정이 최대 약 8초 지연될 수 있음(의도된 안전지연)
- HOTFIX-MDD-EFFECTIVE-20 수정 파일: `trade_page.py`, `tests/test_stage15_trade_page_regression.py`, `tasks/todo.md`
- 핵심 변경: 화면/저장 MDD 값(`15%`)은 그대로 두고, 실제 MDD 스탑 계산/정렬 기준은 `20%` 고정(`MDD_STOP_EFFECTIVE_RATIO`)으로 통일
- 로깅 변경: `MDD stop ratio override active`, `MDD stop price prepared`, `Phase2 MDD stop evaluated` 로그에 유효 비율을 명시
- 검증: `python3 -m py_compile trade_page.py tests/test_stage15_trade_page_regression.py` 통과
- 테스트: `python3 -m unittest tests/test_stage15_trade_page_regression.py` 통과(36 tests)
- 잔여 리스크: 기존 15% 기준으로 고정해 둔 외부/수동 점검 시나리오가 있으면 기대 스탑값이 달라질 수 있어, 운영 체크리스트 기준값을 20%로 갱신해야 함
- HOTFIX-MDD-SECOND 수정 파일: `auto_trade/orchestrator.py`
- 핵심 변경: `sync_entry_fill_flow()`에서 `SECOND_ENTRY/PARTIALLY_FILLED`를 terminal로 보지 않고 `second_entry_order_pending=True` 유지
- 기대 효과: PARTIAL 이후 다음 루프에서 FILLED 재동기화가 수행되어 `SECOND_ENTRY_FILLED_PHASE2_CONFIRM` 경로 및 MDD 제출 트리거가 복구됨
- 검증: `python3 -m py_compile auto_trade/orchestrator.py trade_page.py auto_trade/execution_flow.py auto_trade/entry_pipeline.py` 통과
- 추가 검증: 단위 시나리오 스크립트로 `PARTIAL -> FILLED` 전이 시 `pending=True -> False`, `submit_mdd_stop=False -> True` 확인
- 잔여 리스크: 이미 손상된 런타임 상태(재시작 직후 `second_entry_order_pending=False`)에서 과거 PARTIAL 이력을 잃은 세션은 별도 복구 로직이 필요할 수 있음
- AGG-SECOND-SIZING 수정 파일: `auto_trade/entry_pipeline.py`, `auto_trade/orchestrator.py`, `tests/test_stage10_entry_pipeline.py`
- 핵심 변경: 2차 진입 예산 계산을 `available_usdt * (1 - margin_buffer_pct) * mode_multiplier`로 변경하고, 오케스트레이터가 2차 파이프라인에 `selected_entry_mode`를 전달하도록 연결
- 로깅 변경: 2차 예산/파이프라인 로그에 `entry_mode`, `mode_multiplier` 필드 추가
- 검증: `python3 -m py_compile auto_trade/entry_pipeline.py auto_trade/orchestrator.py tests/test_stage10_entry_pipeline.py` 통과
- 테스트: `python3 -m unittest tests/test_stage10_entry_pipeline.py` 통과(14 tests)
- 추가 테스트: `python3 -m unittest tests/test_stage13_orchestrator_integration.py` 통과(29 tests)
- 잔여 리스크: 공격적 모드에서 2차 주문 수량이 커져 체결 시점 가용증거금/수수료 여유가 부족하면 `INSUFFICIENT_MARGIN` 빈도가 증가할 수 있으며, 현재는 기존 margin-refresh 재시도 경로로 완화됨
- HOTFIX-LAST-PRICE-ENFORCE 수정 파일: `trade_page.py`
- 핵심 변경: PHASE 정책 루프에서 stop-family open-order의 `workingType`을 검사해 `MARK_PRICE` 잔존 주문을 자동 취소 대상으로 분류하고, 다음 루프에서 `CONTRACT_PRICE` 기준 주문으로 재생성되도록 보강
- 보강 변경: user stream/open-order 정규화 경로에 `workingType` 필드 보존 로직 추가(`wt`/`workingType` -> `workingType`)
- 트리거 보강: 진입 트리거 사이클에서 가격 누락 심볼은 REST last-price 보강 조회 후 제출 판단하도록 변경
- 모니터링 보강: `workingType` 이상(누락/비CONTRACT) 이벤트를 user stream/open-order 병합/phase 스캔에서 계수하고, throttled 상세 로그 + 60초 요약 로그를 추가
- 검증: `python3 -m py_compile trade_page.py auto_trade/order_gateway.py auto_trade/entry_pipeline.py auto_trade/orchestrator.py tests/test_stage9_order_gateway.py tests/test_stage10_entry_pipeline.py tests/test_stage11_execution_flow.py tests/test_stage13_orchestrator_integration.py` 통과
- 테스트: `python3 -m unittest tests.test_stage9_order_gateway tests.test_stage10_entry_pipeline tests.test_stage11_execution_flow tests.test_stage13_orchestrator_integration` 통과(83 tests)
- 요청사항 점검:
- 1) 주문 가격 기준: 신규 stop-family 주문은 `CONTRACT_PRICE`로 생성되고, 기존 `MARK_PRICE` stop-family 주문은 정책 루프에서 교체되도록 반영
- 2) 진입 트리거 주문: entry는 trigger order(STOP/TAKE_PROFIT) 경로를 유지하며, mark price 누락 시 REST fallback으로 타입 결정 입력값(`reference_mark_price`) 보강
- 3) tasks/todo 반영: 본 HOTFIX 항목 4건 추가 후 완료 체크 및 Review 기록 반영 완료
- 잔여 리스크: 거래소 응답에서 `workingType`이 비어 오는 비정형 payload는 강제교체 대상에서 제외되므로, 운영 로그에서 해당 케이스 존재 여부를 1회 모니터링 필요
- RELEASE-2.1.5 수정 파일: `config.py`, `version.json`, `tasks/todo.md`
- 빌드: `.venv/Scripts/python.exe build.py --target all` 실행 완료(`dist/LTS V2.1.5.exe`, `dist/LTS-Updater.exe`)
- 배포 파일 반영: `dist` 산출물을 루트 `LTS V2.1.5.exe`, `LTS-Updater.exe`로 복사
- SHA256:
- `LTS V2.1.5.exe` = `d5533cecdb85394f23a2fe8e46a3377ea0086d75d5132238f84d78dc2f7f360c`
- `LTS-Updater.exe` = `32cae164cd0a223340b173bc171e1a7d05c58b87b94e43e4e4faa3b6a305399f`
- 자동업데이트 메타 점검: `min_version=2.1.5`, `app_url=LTS%20V2.1.5.exe`, `app_sha256/updater_sha256` 모두 신규 산출물과 일치
- HOTFIX-ENTRY-2021-LIMIT-FALLBACK 수정 파일: `auto_trade/entry_pipeline.py`, `tests/test_stage10_entry_pipeline.py`, `tasks/todo.md`
- 핵심 변경: ENTRY stop-family 주문이 `-2021 (immediate trigger)`로 거절되면 동일 진입예정가 기준 `LIMIT SELL`을 즉시 1회 폴백 제출(1차/2차 공통)
- 로깅 변경: `entry_pipeline`에 `fallback_entry_limit_on_immediate_trigger_reject` 이벤트 추가(감지/폴백결과 분리)
- 검증: `python3 -m py_compile auto_trade/entry_pipeline.py tests/test_stage10_entry_pipeline.py` 통과
- 테스트: `python3 -m unittest tests/test_stage10_entry_pipeline.py` 통과(17 tests)
- 추가 테스트: `python3 -m unittest tests/test_stage13_orchestrator_integration.py` 통과(29 tests)
- 잔여 리스크: LIMIT 폴백은 미끄러짐을 줄이는 대신 급반전 구간에서 미체결 확률이 증가할 수 있음(의도된 정책 트레이드오프)
- HOTFIX-SECOND-ENTRY-RETRY 수정 파일: `trade_page.py`, `tests/test_stage15_trade_page_regression.py`, `tasks/todo.md`
- 핵심 변경: 2차 진입 실패/취소 상태에서 `skip_latch`를 add하지 않도록 변경해 PHASE1 루프에서 2차 트리거 재등록이 계속 가능하도록 조정
- 로깅 변경: 2차 제출 실패/동기화 취소 상태에서 `retry remains enabled` 성격의 명시 로그 추가
- 검증: `python3 -m py_compile trade_page.py tests/test_stage15_trade_page_regression.py` 통과
- 테스트: `python3 -m unittest tests/test_stage15_trade_page_regression.py` 통과(36 tests)
- 추가 테스트: `python3 -m unittest tests/test_stage10_entry_pipeline.py` 통과(17 tests), `python3 -m unittest tests/test_stage13_orchestrator_integration.py` 통과(29 tests)
- 잔여 리스크: 증거금 부족/필터 불충족 같은 비일시적 실패에서도 재시도는 계속되므로, 동일 실패가 지속될 때 로그 빈도와 API 호출량 모니터링이 필요함
- RELEASE-2.1.6 수정 파일: `config.py`, `version.json`, `tasks/todo.md`
- 빌드: `.venv/Scripts/python.exe build.py --target all` 실행 완료(`dist/LTS V2.1.6.exe`, `dist/LTS-Updater.exe`)
- 배포 파일 반영: `dist` 산출물을 루트 `LTS V2.1.6.exe`, `LTS-Updater.exe`로 복사
- SHA256:
- `LTS V2.1.6.exe` = `d776ea6dd444907bb95b10c00035cb86234991fb2a607857e9bd1614477988bd`
- `LTS-Updater.exe` = `33a95c0856f0c49964ccf663ee0a15b4862ef69a5b3a5d66e149a6b3a32aca4e`
- 자동업데이트 메타 점검: `min_version=2.1.6`, `app_url=LTS%20V2.1.6.exe`, `app_sha256/updater_sha256` 모두 신규 산출물과 일치
- RELEASE-2.1.7 수정 파일: `config.py`, `version.json`, `tasks/todo.md`
- 빌드: `.venv/Scripts/python.exe build.py --target all` 실행 완료(`dist/LTS V2.1.7.exe`, `dist/LTS-Updater.exe`)
- 배포 파일 반영: `dist` 산출물을 루트 `LTS V2.1.7.exe`, `LTS-Updater.exe`로 복사
- SHA256:
- `LTS V2.1.7.exe` = `4ca655fd842fc1c1cd76aba208fe417ccdf763459f06e615fc7e47de0cf7eeb2`
- `LTS-Updater.exe` = `8f4a74c49b448c46adb689bc06d393d8c5cda4a10ae752b89d4f7c6f638521e3`
- 자동업데이트 메타 점검: `min_version=2.1.7`, `app_url=LTS%20V2.1.7.exe`, `app_sha256/updater_sha256` 모두 신규 산출물과 일치
